<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RBAC Operational API implementation | Mojaloop Hub Operations Framework Documentation</title>
    <meta name="description" content="">
    
    <meta name="description" content="Business Operations Framework Documentation">
    <meta name="theme-color" content="#00a3ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" href="/business-operations-framework-docs/assets/css/0.styles.73bef9ff.css" as="style"><link rel="preload" href="/business-operations-framework-docs/assets/js/app.e79f47cd.js" as="script"><link rel="preload" href="/business-operations-framework-docs/assets/js/2.65c7ddde.js" as="script"><link rel="preload" href="/business-operations-framework-docs/assets/js/3.94d7a4f5.js" as="script"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/10.b28ec649.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/11.6dcdbbcd.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/12.82166dd3.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/13.2649a30f.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/14.2190182f.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/15.b1da6c39.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/16.0cdaddde.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/4.08734184.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/5.f18847b0.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/6.19dda1c1.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/7.53fee368.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/8.0180bbd6.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/9.b5e52db5.js">
    <link rel="stylesheet" href="/business-operations-framework-docs/assets/css/0.styles.73bef9ff.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="main-docs-wrapper"><div class="main-content-wrapper"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/business-operations-framework-docs/" class="home-link router-link-active"><img src="/business-operations-framework-docs/mojaloop_logo_med.png" alt="Mojaloop Hub Operations Framework Documentation" class="logo"> <span class="site-name can-hide">Mojaloop Hub Operations Framework Documentation</span></a> <!----> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technical Guide" class="dropdown-title"><span class="title">Technical Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/" class="nav-link router-link-active">
  Technical Introduction
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/SecurityBC.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  RBAC Operational API implementation
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/Microfrontend-JAMStack.html" class="nav-link">
  Micro-frontend - JAMStack design
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/ReportingBC.html" class="nav-link">
  Reporting BC Implementation
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/ReportDeveloperGuide.html" class="nav-link">
  Reporting Developer Guide
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/SettlementBC.html" class="nav-link">
  Settlement Ops Implementation
  <!----></a></li></ul></div></div><div class="nav-item"><a href="https://mojaloop.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mojaloop
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://docs.mojaloop.io/mojaloop-business-docs/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Business Documents
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div> <!----></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technical Guide" class="dropdown-title"><span class="title">Technical Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/" class="nav-link router-link-active">
  Technical Introduction
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/SecurityBC.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  RBAC Operational API implementation
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/Microfrontend-JAMStack.html" class="nav-link">
  Micro-frontend - JAMStack design
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/ReportingBC.html" class="nav-link">
  Reporting BC Implementation
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/ReportDeveloperGuide.html" class="nav-link">
  Reporting Developer Guide
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/guide/SettlementBC.html" class="nav-link">
  Settlement Ops Implementation
  <!----></a></li></ul></div></div><div class="nav-item"><a href="https://mojaloop.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mojaloop
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://docs.mojaloop.io/mojaloop-business-docs/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Business Documents
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Technical Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/business-operations-framework-docs/guide/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/business-operations-framework-docs/guide/SecurityBC.html" aria-current="page" class="active sidebar-link">RBAC Operational API implementation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#introduction-to-rbac-operational-api-implementation" class="active sidebar-link">Introduction to RBAC Operational API implementation</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#rbac-implementation-details" class="sidebar-link">RBAC Implementation details</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#enforcing-maker-checker" class="sidebar-link">Enforcing Maker-Checker</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#tools-standards-chosen" class="sidebar-link">Tools / standards chosen</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#architecture-overview" class="sidebar-link">Architecture overview</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#how-does-this-design-align-with-the-reference-architecture" class="sidebar-link">How does this design align with the reference architecture?</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#alignment-with-iac-4-xxx" class="sidebar-link">Alignment with IaC 4.xxx</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#performance-characterisation-of-the-rbac-implementation" class="sidebar-link">Performance characterisation of the RBAC implementation</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#logging-into-the-ui" class="sidebar-link">Logging into the UI</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#querying-data-using-the-bc-operational-api-micro-frontend" class="sidebar-link">Querying data using the BC operational API micro-frontend</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#enforcing-seperation-of-duties" class="sidebar-link">Enforcing Seperation of Duties</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#assigning-roles-and-participant-access-to-users" class="sidebar-link">Assigning roles and participant access to users</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#assigning-permissions-to-roles-mutually-exclusive-permission-sets" class="sidebar-link">Assigning permissions to roles &amp; mutually exclusive permission sets</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#ory-keto-implementation-detail" class="sidebar-link">Ory Keto – implementation detail</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#ory-oathkeeper-implementation-detail" class="sidebar-link">Ory Oathkeeper – implementation detail</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#ory-kratos-implementation-detail" class="sidebar-link">Ory Kratos – implementation detail</a></li></ul></li><li><a href="/business-operations-framework-docs/guide/Microfrontend-JAMStack.html" class="sidebar-link">Micro-frontend - JAMStack design</a></li><li><a href="/business-operations-framework-docs/guide/ReportingBC.html" class="sidebar-link">Reporting bounded context implementation</a></li><li><a href="/business-operations-framework-docs/guide/ReportDeveloperGuide.html" class="sidebar-link">Report Developer Guide</a></li><li><a href="/business-operations-framework-docs/guide/SettlementBC.html" class="sidebar-link">Settlement Ops Implementation</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="content content__default"><h1 id="rbac-operational-api-implementation"><a href="#rbac-operational-api-implementation" class="header-anchor">#</a> RBAC Operational API implementation</h1> <h2 id="introduction-to-rbac-operational-api-implementation"><a href="#introduction-to-rbac-operational-api-implementation" class="header-anchor">#</a> Introduction to RBAC Operational API implementation</h2> <p>The objectives of this implementation is to provide an RBAC solution to support hub operations and associated functions. This guide outlines the high-level design and explains the thinking that went into the design.</p> <p>The security design:</p> <ol><li>implements role based access control to the current Mojaloop version</li> <li>is compatible where possible with the reference architecture and therefore future versions of Mojaloop</li> <li>is compatible with future Infrastructure-as-Code (IaC) deployments</li> <li>provides activity logging that can be used in an audit</li></ol> <h2 id="rbac-implementation-details"><a href="#rbac-implementation-details" class="header-anchor">#</a> RBAC Implementation details</h2> <ol><li>Users are assigned one or more roles. A user may ‘take on’ multiple roles, subject to defined rules.</li> <li>Roles are assigned Permissions</li> <li>The Identity and Access Proxy (Ory Oathkeeper) enforces access to endpoints based on permission.</li> <li>Backend API can optionally check permissions through Keto API.</li> <li>Mutually exclusive permission sets can be defined in the system to enforce separation of duties.</li></ol> <h2 id="enforcing-maker-checker"><a href="#enforcing-maker-checker" class="header-anchor">#</a> Enforcing Maker-Checker</h2> <p>There are two approaches that can be taken to enforce a maker-checker validation flow.</p> <ol><li>Enforce using roles and mutually exclusive permissions via security policies. I.e. Makers cannot also be checkers</li> <li>Enforce in application layer security rules; i.e. makers cannot also be checkers within the same validation process. This is often implemented in the application layer when assigning makers and/or checkers as defined in a process flow, and by enforcing that a checker cannot be the same person as the maker in a validation flow. I.e. the code that enforces this will exist within each bounded context.</li></ol> <div class="custom-block tip"><p class="custom-block-title">RBAC responsibility</p> <p>To support this functionality the RBAC system must provide:</p> <ol><li>the User Identifier to that bounded context.</li> <li>A means for checking authorisation if necessary.</li></ol></div> <h3 id="providing-the-user-identifier"><a href="#providing-the-user-identifier" class="header-anchor">#</a> Providing the User Identifier</h3> <p>The current configuration provides the User Identifier in the header of the API calls.<br>
Ory Oathkeeper is configured to use a ‘header’ mutator. This ‘header’ mutator will transform the request, allowing you to pass the credentials to the upstream application via the headers. For example the API backends will get the following header in the http requests.</p> <div class="language- extra-class"><pre class="language-text"><code>X-User: wso2-uuid
</code></pre></div><p>It is worth pointing out that JWT ‘id_token’ are also easily supported my modifying the Ory Oathkeeper mutator configuration. The ‘id_token’ mutator takes the authentication information (e.g. subject) and transforms it to a signed JSON Web Token, and more specifically to an OpenID Connect ID Token. The API backends can verify the token by fetching the (public) key from the /.well-known/jwks.json endpoint provided by the Ory Oathkeeper API.</p> <h3 id="checking-authorisation"><a href="#checking-authorisation" class="header-anchor">#</a> Checking authorisation</h3> <p>All authorisation information is maintained within Ory Keto. Ory Keto has a standard API that can be called to check authorisation.<br>
I.e. It answers the question: <em>‘Does this user identifier token have this permission?’</em></p> <h2 id="tools-standards-chosen"><a href="#tools-standards-chosen" class="header-anchor">#</a> Tools / standards chosen</h2> <p>Here is a list of standard tools that have been chosen to implement the design.</p> <ol><li><strong>Ory Oathkeeper</strong><br>
Will be used as the Identity and Access Proxy (IAP) that will check authentication and authorization before providing access to functional endpoints, that is, it will be used to enforce the access control.</li> <li><strong>Ory Keto</strong><br>
Will check authorization via subject-role and role-permission mappings. It uses a flexible object-, relationship-, and subject structure pioneered at Google that can model many authorization schemes, including Role Based Access Control (RBAC).</li> <li><strong>Ory Kratos</strong><br>
Will use Ory Kratos to create and manage the cookie authorization object.</li> <li><strong>OpenID Connect</strong><br>
Is the standard that has been chosen to interact with an identity management system. This is a widely supported standard, and is compatible with all the tools currently in use in the Mojaloop community, that is, WSO2 Identity Server (IS), Keycloak, and Ory Kratos.</li></ol> <h2 id="architecture-overview"><a href="#architecture-overview" class="header-anchor">#</a> Architecture overview</h2> <p>Here is a high-level architecture overview of the implementation of this RBAC Operational API onto the current Mojaloop version.</p> <p><img src="/business-operations-framework-docs/assets/img/BizOps-Framework-IaC-3.xx-&amp;-Mojaloop-13.xx.3d04fca8.png" alt="Architecture overview diagram of security bounded context implementation"></p> <p>Here is a table of the services and the roles they are playing.</p> <table><thead><tr><th>Service</th> <th>Owns</th> <th>Implements</th></tr></thead> <tbody><tr><td><strong>WSO2 IS KM</strong></td> <td>Users</td> <td>1. User login redirection and UI that creates the cookie token <br>2. Standard OpenID Connect (OIDC) authorization code flow</td></tr> <tr><td><strong>Ory Keto</strong></td> <td>1. The roles mapped to users <br> 2. The participant mapped to users</td> <td>1. API RBAC authorization check through Ory Oathkeeper<br>2. API RBAC authorization check through operational API call</td></tr> <tr><td><strong>Ory Oathkeeper</strong></td> <td>The permissions related to API access</td> <td>API gateway for operational APIs with authentication and authorization checks</td></tr> <tr><td><strong>Ory Kratos</strong></td> <td>Nothing</td> <td>Authentication cookie</td></tr> <tr><td><strong>BC Operational API</strong></td> <td>The permissions related to the operational API calls</td> <td>Operational API functions</td></tr> <tr><td><strong>Shim</strong></td> <td>nothing</td> <td>Redirect to configure OIDC</td></tr> <tr><td><strong>Operator Role</strong></td> <td>Nothing</td> <td>Update Keto to reflect role-permission assignment changes made in the role-resource file</td></tr> <tr><td><strong>Kubernetes role-resource file</strong></td> <td>The roles and the role-permission assignments</td> <td>Edits of this file are controlled through a version control implementaiton (for example, GitHub or GitLab).</td></tr> <tr><td><strong>Roles API</strong></td> <td>Nothing</td> <td>1. Role-user API controls <br>(list of users, list of roles, list of roles assigned to users, add role to user, remove role from user)<br> 2. Participant-user API controls <br>(list of users, list of participants, list of participants assigned to user, add participant to user, remove participant from user)</td></tr></tbody></table> <h2 id="how-does-this-design-align-with-the-reference-architecture"><a href="#how-does-this-design-align-with-the-reference-architecture" class="header-anchor">#</a> How does this design align with the reference architecture?</h2> <p>Let’s compare this RBAC Operational API implementation to the security bounded context as defined in the reference architecture. This design differs from the reference architecture in function, purpose and approach, but where appropriate has adopted some of the design ideas. This RBAC implementation’s purpose is to adds a layer for security onto the operational API’s of the bounded contexts. The Reference Architecture’s Security Bounded Context design has been designed to accommodate for the performance requirements of the critical transactional functions of Mojaloop.<br>
Here are the high level areas where these designs diverge:</p> <ol><li>The authorisation functions are centralised in this RBAC implementation. The reference architecture design requires a distributed authorisation that is implemented in each bounded context independently. This extra level of complexity is unnecessary for the operational API use case.</li> <li>The reference architecture design requires interfaces to other bounded contexts to initiate the distributed authorisation functionality. These have not been built for the reason that there are no components that exist that could consume these interfaces.</li> <li>The reference architecture requires the security BC to generate it’s own security tokens. This RBAC implementation uses the tokens that are generated by the IAM.</li> <li>The reference architecture requires the permissions to be distributed through the JWT to each bounded context. This is possible to configure in the current toolset, but was not. The reason being that some security experts consider this distribution of user permission sets a security vulnerability, and it was not a requirement for this current RBAC implementation.</li></ol> <p>There are parts of the security bounded context that have been adopted in this RBAC Operational API implementation.</p> <ol><li>Each Bounded context owns it’s own set of permissions or privileges</li> <li>The RBAC implementation owns all the associations of privileges to users.</li> <li>The user Role Permissions are structured so that they are easily distributed within a Kubernetes cluster.</li></ol> <h2 id="alignment-with-iac-4-xxx"><a href="#alignment-with-iac-4-xxx" class="header-anchor">#</a> Alignment with IaC 4.xxx</h2> <p>Here is a diagram illustrating how the high-level architecture would look if this RBAC Operational API implementation design was implemented on the next IaC version (IaC 4.xxx version) that uses Keycloak and Ambassador / Envoy amongst other changes.</p> <p><img src="/business-operations-framework-docs/assets/img/BizOps-Framework-IaC-4.xx-&amp;-Mojaloop-13.xx.819333e3.png" alt="Architecture overview diagram of security bounded context implementation"></p> <h2 id="performance-characterisation-of-the-rbac-implementation"><a href="#performance-characterisation-of-the-rbac-implementation" class="header-anchor">#</a> Performance characterisation of the RBAC implementation</h2> <p>A performance characterisation of the RBAC POC implementation was performed in order to evaluate the extent of the performance overhead that the RBAC security layer has.</p> <div class="custom-block tip"><p class="custom-block-title">In summary:</p> <p>The RBAC adds 10ms overhead for each API authorisation check per call.<br>
If a particular API call requires and additional API based authorisation call, then the overhead is 20ms.</p> <p>This typically in our test queries amounted to:</p> <ol><li>less than 5% for single authorisation checks (Ory Oathkeeper &amp; Ory Keto),</li> <li>and less than 10% for double authorisation checks (Ory Oathkeeper &amp; Ory Keto and an additional Ory Keto call).</li></ol></div> <p><strong>Characterisation test setup details</strong><br>
On the same test infrastructure, identical timed calls were made to the same backend API directly and and through the RBAC implementation.<br>
Below are the results of the test calls made to the role API with and without RBAC, and POST Transfers API with and without RBAC. The Role API has a single authorisation check that is performed through Ory Oathkeeper that calls Ory Keto. The Transfer API is a graph QL API that has an additional RBAC</p> <p><strong>Request Statistics</strong></p> <table><thead><tr><th>Method</th> <th>Name</th> <th># Requests</th> <th># Fails</th> <th>Average (ms)</th> <th>Min (ms)</th> <th>Max (ms)</th> <th>Average size</th> <th>(bytes)	RPS</th> <th>Failures/s</th></tr></thead> <tbody><tr><td>GET</td> <td>Role API</td> <td>321</td> <td>0</td> <td>248</td> <td>221</td> <td>499</td> <td>604</td> <td>9.0</td> <td>0.0</td></tr> <tr><td>GET</td> <td>Role API RBAC</td> <td>320</td> <td>0</td> <td>262</td> <td>232</td> <td>418</td> <td>604</td> <td>8.9</td> <td>0.0</td></tr> <tr><td>POST</td> <td>Transfers API</td> <td>318</td> <td>0</td> <td>229</td> <td>184</td> <td>373</td> <td>4873</td> <td>8.9</td> <td>0.0</td></tr> <tr><td>POST</td> <td>Transfers API RBAC</td> <td>314</td> <td>0</td> <td>240</td> <td>194</td> <td>406</td> <td>4873</td> <td>8.8</td> <td>0.0</td></tr> <tr><td></td> <td><strong>Aggregated</strong></td> <td><strong>1273</strong></td> <td><strong>0</strong></td> <td><strong>245</strong></td> <td><strong>184</strong></td> <td><strong>499</strong></td> <td><strong>2723</strong></td> <td><strong>35.5</strong></td> <td><strong>0.0</strong></td></tr></tbody></table> <p><strong>Response Time Statistics</strong></p> <table><thead><tr><th>Method</th> <th>Name</th> <th>50%ile (ms)</th> <th>60%ile (ms)</th> <th>70%ile (ms)</th> <th>80%ile (ms)</th> <th>90%ile (ms)</th> <th>95%ile (ms)</th> <th>99%ile (ms)</th> <th>100%ile (ms)</th></tr></thead> <tbody><tr><td>GET</td> <td>Role API</td> <td>240</td> <td>240</td> <td>240</td> <td>250</td> <td>270</td> <td>290</td> <td>400</td> <td>500</td></tr> <tr><td>GET</td> <td>Role API RBAC</td> <td>250</td> <td>260</td> <td>260</td> <td>270</td> <td>290</td> <td>320</td> <td>410</td> <td>420</td></tr> <tr><td>POST</td> <td>Transfers API</td> <td>220</td> <td>220</td> <td>240</td> <td>250</td> <td>290</td> <td>330</td> <td>360</td> <td>370</td></tr> <tr><td>POST</td> <td>Transfers API RBAC</td> <td>230</td> <td>240</td> <td>250</td> <td>280</td> <td>310</td> <td>330</td> <td>400</td> <td>410</td></tr> <tr><td></td> <td><strong>Aggregated</strong></td> <td><strong>240</strong></td> <td><strong>250</strong></td> <td><strong>250</strong></td> <td><strong>260</strong></td> <td><strong>290</strong></td> <td><strong>320</strong></td> <td><strong>400</strong></td> <td><strong>500</strong></td></tr></tbody></table> <h2 id="logging-into-the-ui"><a href="#logging-into-the-ui" class="header-anchor">#</a> Logging into the UI</h2> <p>This sequence diagram illustrates the events that occur when a browser attempt to access a backend API.</p> <ul><li>If the browser is already logged in, then the request is forwarded.</li> <li>If the browser is not logged in, then a standard OIDC authorization flow is triggered starting with a redirect.</li></ul> <p><img src="/business-operations-framework-docs/assets/img/frontend.d9344aac.png" alt="Sequence diagram illustrating how a brower logs in"></p> <h2 id="querying-data-using-the-bc-operational-api-micro-frontend"><a href="#querying-data-using-the-bc-operational-api-micro-frontend" class="header-anchor">#</a> Querying data using the BC operational API micro-frontend</h2> <p>The following sequence diagram shows more details regarding interactions when:</p> <ul><li>the bearer token is valid or invalid</li> <li>authorization passes or fails</li></ul> <p>The micro-frontend is represented as a client.</p> <p><img src="/business-operations-framework-docs/assets/img/client.37f105e9.png" alt="Sequence diagram illustrating how an API client call has its authorization performed"></p> <p>In some cases there might be a requirement for a more detailed authorization check to be performed by the operational API. The next sequence diagram describes how that is implemented.</p> <p>It is important to note that not all operational APIs will require this level of authorization, and that the Ory Oathkeeper control may or may not be required in this use case.</p> <p><img src="/business-operations-framework-docs/assets/img/clientgraphql.22a3366f.png" alt="Sequence diagram illustrating how an API client call has its authorization performed"></p> <h2 id="enforcing-seperation-of-duties"><a href="#enforcing-seperation-of-duties" class="header-anchor">#</a> Enforcing Seperation of Duties</h2> <p>This RBAC implementation supports the enforcement of separation of duties by the enforcement of mutually exclusive permissions sets. The implementation of separation of duty creates tighter security but can lead to complexity for the security administrator and the end users who use the system. Enforcing mutually exclusive permissions can reduce and help manage this complexity.</p> <p>An example of mutually exclusive permissions might be a user being able to access the Finance Portal and to carry out sensitive functions such as add/withdraw funds. This user should not also have access to audit functions.</p> <h3 id="modelling-the-exclusion"><a href="#modelling-the-exclusion" class="header-anchor">#</a> Modelling the exclusion</h3> <p>This implementation models this requirements as a set of mutually exclusive permission - permission exclusions that are enforced globally. These exclusions are defined as two sets of permissions that are mutually exclusive which is intuitive and easy to maintain.</p> <p><em>Justification</em><br>
There are three possible ways that this exclusion could have been modelled namely:</p> <ol><li>Permission - Permission exclusions</li> <li>User Role - User Role exclusions</li> <li>User Role - Permission exclusions</li></ol> <p>Because this functionality has been added to support the segregation/separation of duties, the cleanest way of enforcing this is to have a permission pair exclusion that is globally enforced. With all the other options, there is the possibility that the exclusion can be bypassed with the addition of a new inclusive role.</p> <h3 id="synthetic-roles-vs-multiple-user-roles"><a href="#synthetic-roles-vs-multiple-user-roles" class="header-anchor">#</a> Synthetic Roles Vs Multiple User Roles</h3> <p>This RBAC implementation does not implement synthetic roles, but rather uses multiple functional user roles assignments.</p> <p><em>Justification</em><br>
These are two methods that can be used to model RBAC permissions with mutually exclusive permissions.</p> <ol><li>Dynamically building up a synthetic role for each user based on rules associated with the current assigned roles and their permissions and exclusions.</li> <li>Defining roles that are associated with user functions. Each user therefore will need to be assigned more than one role. Roles permissions are less likely to change.</li></ol> <p>The preference is to implement multiple functional roles. This is because it is much simpler to understand, maintain and support this method. Identifying the cause of a loss of permission in a synthetic role because of multiple role assignments and subsequent rule applications requires a detailed understanding of the process of how the synthetic roles are calculated and implemented. This complexity is avoided with the second option.</p> <h3 id="multiple-user-role-assignments-required-dynamic-checking-of-exclusions"><a href="#multiple-user-role-assignments-required-dynamic-checking-of-exclusions" class="header-anchor">#</a> Multiple user role assignments required dynamic checking of exclusions</h3> <p>Allowing the system administrator to assign more than one role to a user is convenient, flexible and limits the number of roles required within the organisation. This also means that it is possible to violate a mutually exclusive permission by assigning users to roles. Checking and enforcing these exclusions therefore need to be dynamic.</p> <p>There are a number of places that this dynamic check needs to take place.</p> <ol><li>On the assignment of a role to a user</li> <li>On the application of a new role-permission resource definition, or the application of a new security policy that may include a wholesale change of permission and role structures.</li></ol> <div class="custom-block warning"><p class="custom-block-title">Future extension:</p> <p>If it is possible that a violation can exist in the system, then each time a permission is checked, exclusion violations should also be checked. Currently this is not designed for as it is assumed that 1 &amp; 2 are sufficiently implemented that a violation cannot exist.<br>
It is recommended that this additional check be roadmapped for future extensions as this would ensure that no back-door override can be made to violate this separation of duties.</p></div> <div class="custom-block tip"><p class="custom-block-title">Note:</p> <p>The change control release and testing on lower environments may not catch these violations. Testing for these violations cannot be done on lower environments without first making sure that the user access control is identical in the lower environments which is normally not the case.</p></div> <p><strong>Keto relation</strong><br>
Introduction of a relation that relates two permissions that cannot be held together.</p> <div class="language- extra-class"><pre class="language-text"><code>“permission:X excludes permission:Y#allowed”
</code></pre></div><p><strong>Permission Exclusion Custom Resource Definition</strong><br>
A permission exclusion custom resources are consumed by the Role Permission Controller, which will upload the  exclusions into Keto using this relation. Each will contain two sets of permissions, and holding any permission in one set will mean no permission in the other set can be held. This allows for many flexible scenarios, and the simplest scenario of “any person who can do this one thing cannot do this other thing, and vice versa” remains simple to express.</p> <p><strong>Role Permission Operator API Validation Check</strong><br>
The Role Permission Resource Controller will provide an API that can be used to check a security permission update’s allowability before it is applied. That API will take a proposed change to a particular Role Permission resource and calculate whether or not any existing users would have mutually exclusive permissions after that change, returning the result. This API will be usable by the administrative UI and CI systems to “preflight” changes for likely problems.</p> <p><strong>Role Permission Operator Change Enforcement</strong><br>
When a role-permission resource is changed, the role-permission operator will first lock the ability to change user role assignments, then perform the same check as the validation API does, and if the resource does not pass the check it will not accept the changes from that resource, instead maintaining the current role permission assignments, and surfacing the issue as an error in the kubernetes API for instrumentation and alerting.</p> <p><strong>Conflict Check on User Role Assignment</strong><br>
When a user is assigned a role, the user role assignment API will validate that the change does not result in the user having two mutually excluded permissions. If it does, the change will be rejected and an error returned.</p> <h2 id="assigning-roles-and-participant-access-to-users"><a href="#assigning-roles-and-participant-access-to-users" class="header-anchor">#</a> Assigning roles and participant access to users</h2> <p>This functionality is implemented in the Roles API service. The following sequence diagram describes how the user role and user participation access is queried and modified through the Roles API.<br> <img src="/business-operations-framework-docs/assets/img/userroles.e6bca593.png" alt="Sequence diagram illustrating how roles and participant access is assigned to users"></p> <h3 id="roles-api"><a href="#roles-api" class="header-anchor">#</a> Roles API</h3> <p>The following table provides a summary of Roles API resources.</p> <table><thead><tr><th>Category</th> <th>HTTP method</th> <th>Endpoint</th> <th>Description</th> <th>Error codes</th></tr></thead> <tbody><tr><td><strong>HEALTH</strong></td> <td></td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>GET</td> <td>/health</td> <td>Used to return the current status of the API</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>GET</td> <td>/metrics</td> <td>Used to return metrics for the API</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td><strong>PARTICIPANTS</strong></td> <td></td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>GET</td> <td>/participants</td> <td>Used to return a list of participant IDs</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td><strong>ROLES</strong></td> <td></td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>GET</td> <td>/roles</td> <td>Used to return a list of role IDs</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td><strong>USERS</strong></td> <td></td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>GET</td> <td>/users</td> <td>Used to return a list of user IDs</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>GET</td> <td>/users/{ID}</td> <td>Used to return a specifc user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>GET</td> <td>/users/{ID}/participants</td> <td>Used to return a list of participants assigned to a user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>PATCH</td> <td>/users/{ID}/participants</td> <td>Used to assign a participant to a user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>GET</td> <td>/users/{ID}/roles</td> <td>Used to return a list of roles assigned to a user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>PATCH</td> <td>/users/{ID}/roles</td> <td>Used to assign a role to a user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr></tbody></table> <p>The detailed specification of the Roles API can be found <a href="https://docs.mojaloop.io/role-assignment-service/" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.<br>
The GitHub repository of the role assignment service can be found <a href="https://github.com/mojaloop/role-assignment-service" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="assigning-permissions-to-roles-mutually-exclusive-permission-sets"><a href="#assigning-permissions-to-roles-mutually-exclusive-permission-sets" class="header-anchor">#</a> Assigning permissions to roles &amp; mutually exclusive permission sets</h2> <p>The permission to role assignment is stored in a <code>.yml</code> file that we are calling a role-resource file (<code>roleresource.yml</code>).<br>
Access and changes to these role-resource files will be managed through a hosted version control solution like GitHub or GitLab. This is convenient as this keeps a full history of changes and has configurable automatic and manual control points.<br>
These role-resource files are mapped as Kubernetes custom resource definitions (CRDs) to which a role-permission operator subscribes. Changes to the role-resource files trigger the role-permission operator to update Ory Keto with the corresponding appropriate change. A role can be represented by more than one file if necessary.</p> <p>There are two types of role resource files, the first contains the role permission assignments and the second the mutually exclusive permission sets.</p> <p>Here is an example of a permission assignment role-resource file:</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;mojaloop.io/v1&quot;</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MojaloopRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> arbitrary<span class="token punctuation">-</span>name<span class="token punctuation">-</span>here
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># must match what is used in Keto, whatever that is</span>
  <span class="token key atrule">role</span><span class="token punctuation">:</span> RoleIdentifier
  <span class="token key atrule">permissions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> permission_01
  <span class="token punctuation">-</span> permission_02
  <span class="token punctuation">-</span> permission_03
  <span class="token punctuation">-</span> permission_04'
</code></pre></div><p>The following sequence diagram illustrates how Ory Keto is updated.</p> <p><img src="/business-operations-framework-docs/assets/img/rolepermissions.b30c621c.png" alt="Sequence diagram illustrating how roles and participant access is assigned to users"></p> <h2 id="ory-keto-implementation-detail"><a href="#ory-keto-implementation-detail" class="header-anchor">#</a> Ory Keto – implementation detail</h2> <p>Ory Keto in this design is the tool that implements the logic of whether a login token has the correct authorization to access an aspect of the system, that is, it is used to enforce RBAC. There are three parts to how this is implemented in Keto:</p> <ol><li>The assignment of roles to users.<br>
This functionality will be maintained and updated from the Roles API module, which will call and update Keto accordingly.</li> <li>The assignment of participant access to a user.<br>
This refers to the DFSP access reports that must only be provided for the configured participants.<br>
This functionality will also be maintained via the Roles API module, which will call and update Keto accordingly.</li> <li>The assignment of permissions or privileges to roles.<br>
This will be controlled through the edits of a GitHub <code>roleresource.yml</code> file. The Kubernetes role-permission operator is the service that will monitor these role-resource files, and update Keto to affect the assignments.</li></ol> <h3 id="adding-roles-and-participant-access-to-users-in-keto"><a href="#adding-roles-and-participant-access-to-users-in-keto" class="header-anchor">#</a> Adding roles and participant access to users in Keto</h3> <p>The user list (which includes both people and service accounts) will be retrieved from WSO2 Identity Server, and the participant list from the existing API for that purpose. In both cases, a durable permanent identifier should be what is then used as part of the Keto calls.</p> <p>The list of roles will be hardcoded, and every role should be given a unique short identifier that is human readable and writeable, as well as a name. The UI should display both the identifier and the name, since the identifier will be needed for use in the role-permission operator.</p> <p>There will be two Keto namespaces used for calls: role and participant. The Keto tuples used will be:</p> <div class="language- extra-class"><pre class="language-text"><code>role:ROLEID#member@USERID and participant:PARTICIPANTID#member@USERID 
</code></pre></div><p>(using the notation used for <a href="https://www.ory.sh/keto/docs/concepts/relation-tuples" target="_blank" rel="noopener noreferrer">Keto/Zanzibar<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>The reuse of the relation <code>&quot;member&quot;</code> is not an issue, each relation is namespace-specific. If there is a preferred term for the participant-user relationship other than <code>&quot;member&quot;</code>, that word can be used instead, and should be documented here.</p> <p>To retrieve the role or participant list for a particular user, the <a href="https://www.ory.sh/keto/docs/reference/rest-api#query-relation-tuples" target="_blank" rel="noopener noreferrer">Query Relation Tuples API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will be used, and the namespace, relation, and subject provided as parameters. This will provide a list of tuples in the response, with a next page token if there are additional results, and the identifiers for the participants or roles can be read from the resulting tuples.</p> <p>When a role or participant is added or removed for a user, the <a href="https://www.ory.sh/keto/docs/reference/rest-api#create-a-relation-tuple" target="_blank" rel="noopener noreferrer">create<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://www.ory.sh/keto/docs/reference/rest-api#delete-a-relation-tuple" target="_blank" rel="noopener noreferrer">delete<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> relation tuple calls can be used, since only a single tuple is involved at a time. If the call fails, but the failure is not an HTTP 4xx, it should be retried a couple of times.</p> <p>Here is an example of the Keto API call used to add roles to users.</p> <div class="custom-block tip"><p class="custom-block-title">Example: Assign role to user in Ory Keto</p> <p>PATCH /relation-tuples HTTP/1.1<br>
Content-Type: application/json<br>
Accept: application/json</p></div> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;relation_tuple&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;namespace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token string">&quot;RoleIdentifier&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;relation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;member&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userIdentifier&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>On success, an HTTP 204 message is returned with no content.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>We use <code>&quot;member&quot;</code> as the <code>&quot;relation&quot;</code> in our current implementation.<br>
We use <code>PATCH</code> instead of <code>PUT</code> since <code>PATCH</code> works as a bulk create and/or delete.</p></div> <h3 id="adding-permissions-or-privileges-to-roles-in-keto"><a href="#adding-permissions-or-privileges-to-roles-in-keto" class="header-anchor">#</a> Adding permissions or privileges to roles in Keto</h3> <p>Adding permissions or privileges to roles in KetoThis will be done via a Kubernetes operator for a Custom Resource Definition <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/_print/" target="_blank" rel="noopener noreferrer">(CRD)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The operator could be implemented in most any language. Existing ModusBox operator expertise is mostly based around <code>kopf</code>, a Python framework, but there are options in Go and Node as well (and others).</p> <p>The operator should maintain a memory of all resources it manages, grouped by role. <a href="https://kopf.readthedocs.io/en/latest/indexing/" target="_blank" rel="noopener noreferrer">Kopf’s indexing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> functionality is ideal for this.</p> <p>When a role resource is changed, the list of permissions for that role across all role resources should be compiled, and a change sent through the Keto Patch <a href="https://www.ory.sh/keto/docs/reference/rest-api#patch-multiple-relation-tuples" target="_blank" rel="noopener noreferrer">Multiple Relation Tuples API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> using the patch actions <code>insert</code> and <code>delete</code>. It is necessary to take all role resources into account, because there may be multiple resources for one role, and more than one may include the same permission, so deleting a role resource that maps Role X to Permission P does not necessarily mean that the Keto tuple for that role-permission connection needs to be deleted, since there may still be another role resource mapping Role X to Permission P.</p> <p>The Keto tuples will be of the form:</p> <div class="language- extra-class"><pre class="language-text"><code>permission:PERMISSIONID#granted@role:ROLEID#member
</code></pre></div><p>The specific operations on resource change are as follows:</p> <ol><li>Retrieve current permissions granted for role using the <a href="https://www.ory.sh/keto/docs/reference/rest-api/#query-relation-tuples" target="_blank" rel="noopener noreferrer">Query Relation Tuples API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Based on stored index of roles to permissions, compute a diff from the retrieved list.</li> <li>Execute patch from diff.</li> <li>If there are problems, throw an exception so the problem will log and a re-sync will be attempted later.</li></ol> <p>Here is an example of the Keto API call used to add permissions to roles.</p> <div class="custom-block tip"><p class="custom-block-title">Example: Assign permission/privilege to a role in Ory Keto</p> <p>PATCH /relation-tuples HTTP/1.1<br>
Content-Type: application/json<br>
Accept: application/json</p></div> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
  <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;relation_tuple&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;namespace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;permission&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token string">&quot;permissionIdentifier&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;relation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;granted&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;role:x#member&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>On success, an HTTP 204 message is returned with no content.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>We use <code>&quot;granted&quot;</code> as the <code>&quot;relation&quot;</code> in our current implementation.<br>
We use <code>PATCH</code> instead of <code>PUT</code> since <code>PATCH</code> works as a bulk create and/or delete.</p></div> <h3 id="adding-mutually-exclusive-permisions-to-keto"><a href="#adding-mutually-exclusive-permisions-to-keto" class="header-anchor">#</a> Adding mutually exclusive permisions to Keto</h3> <p>The mutually exclusive permission sets are also maintained and modelled in Keto using the ‘excludes’ relation.<br>
Relation that relates two permissions that cannot be held together are represented with exclusion tuples:</p> <div class="language- extra-class"><pre class="language-text"><code>“permission:X excludes permission:Y#allowed”
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>We use <code>&quot;excludes&quot;</code> as the <code>&quot;relation&quot;</code> to define mutually exclusive permissions.</p></div> <h3 id="calling-the-standard-keto-api-to-check-authorization"><a href="#calling-the-standard-keto-api-to-check-authorization" class="header-anchor">#</a> Calling the standard Keto API to check authorization</h3> <p>Checking to see if a user has authorization for a privilege or permission is managed by th API gateway, and if necessary can be checked by each bounded context.</p> <p>Here is an example of the Keto API call used to check for a user’s authorization based on a permission/privilege.</p> <div class="custom-block tip"><p class="custom-block-title">Example: Checking for authorization in Ory Keto</p> <p>POST /check HTTP/1.1<br>
Content-Type: application/json<br>
Accept: application/json</p></div> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;namespace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;permission&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PermissionIdentifier&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;relation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;granted&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UserIdentifier&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Here is the response that comes back:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;allowed&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>/<span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Note:</p> <p>Mutally excluded permissions don’t need to be check excplicitly through a Keto call because the system is maintained in such a way that role-permission assignments can only be defined if mutually exclusive permission sets are not violated.</p></div> <h2 id="ory-oathkeeper-implementation-detail"><a href="#ory-oathkeeper-implementation-detail" class="header-anchor">#</a> Ory Oathkeeper – implementation detail</h2> <h3 id="configuring-ory-oathkeeper-for-bizops"><a href="#configuring-ory-oathkeeper-for-bizops" class="header-anchor">#</a> Configuring Ory Oathkeeper for BizOps</h3> <p><a href="https://www.ory.sh/oathkeeper/docs/next/" target="_blank" rel="noopener noreferrer">ORY Oathkeeper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> authorizes incoming HTTP requests. It can be the Policy Enforcement Point in your cloud architecture, that is, a reverse proxy in front of your upstream API or web server that rejects unauthorized requests and forwards authorized ones to your server. If you want to use another API Gateway (Kong, Nginx, Envoy, AWS API Gateway, and so on), Ory Oathkeeper can also plug into that and act as its Policy Decision Point.</p> <p>The Ory Oathkeeper Helm chart is described at <a href="https://k8s.ory.sh/helm/oathkeeper.html" target="_blank" rel="noopener noreferrer">ORY Oathkeeper Helm Chart | k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and defined in <a href="https://github.com/ory/k8s/tree/master/helm/charts/oathkeeper" target="_blank" rel="noopener noreferrer">k8s/helm/charts/oathkeeper at master · ory/k8s · GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The Ory Helm repository is documented at <a href="https://k8s.ory.sh/helm/" target="_blank" rel="noopener noreferrer">ORY Helm Charts | k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The Ory Oathkeeper configuration reference is at <a href="https://www.ory.sh/oathkeeper/docs/reference/configuration" target="_blank" rel="noopener noreferrer">Configuration | ORY Oathkeeper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> but note that the Helm chart values have different ways of doing certain things. Also, every configuration value can be overridden with environment variables.</p> <p>The Ory Oathkeeper Helm chart deploys two key components into Kubernetes: Ory Oathkeeper itself, and the Ory Oathkeeper Maester. Ory Oathkeeper is stateless and config-driven, and seamlessly reloads itself with zero downtime, anytime that config changes. Ory Oathkeeper Maester is a controller for the Rule CRD, and composes the Rule objects in Kubernetes into a single complete rules file that is loaded by Ory Oathkeeper.  By default, that is a ConfigMap that Ory Oathkeeper mounts, but it can also be set to run as a sidecar and use a shared mount.</p> <p>Ory Oathkeeper exposes two ports as two services. One service is the API service, and the other is the Proxy service. Long-term, we will be using the API service, which will be queried by the next generation API Gateway using the Access Control Decision API  (see <a href="https://www.ory.sh/oathkeeper/docs/reference/api/#access-control-decision-api" target="_blank" rel="noopener noreferrer">REST API | ORY Oathkeeper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ) that Ory Oathkeeper provides, but for now we will be using the Proxy service, and exposing that via Ingress. External URLs to services protected by Ory Oathkeeper will be pointed at the Ory Oathkeeper Proxy ingress, which will then proxy access to the internal services at those URLs and apply access control rules.</p> <p>Ory Oathkeeper will be configured to generate and sign a JSON Web Token (JWT) containing claims that internal services can check and verify by pointing at the JSON Web Key Set (JWKS) that Ory Oathkeeper will publish (which is part of the configuration) at the well-known URL for JWKS on the API service (see <a href="https://www.ory.sh/oathkeeper/docs/reference/api/#lists-cryptographic-keys" target="_blank" rel="noopener noreferrer">REST API | ORY Oathkeeper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ). If a service does this, then it is operating under a basic zero trust regime, as it will not be possible to call that service except with a token that has been generated by Ory Oathkeeper, and Ory Oathkeeper will only generate a token if the access rules for the given URL allow access.</p> <h3 id="debugging"><a href="#debugging" class="header-anchor">#</a> Debugging</h3> <p>The responses and logs from Ory Oathkeeper tend to be pretty informative, so start there. Make sure you are looking at the logs for the request that matters. Ory Oathkeeper will also be logging health checks and similar.</p> <p>Some possible debugging actions that have been found useful in different circumstances:</p> <ul><li><p>Make a match much more permissive (replacing the entire piece beginning with <code>&lt;.*&gt;</code> and then having the minimum currently unique suffix is good).</p></li> <li><p>Double-check that each internal URL is the proper internal URL by checking it is accessible inside the cluster with curl.</p></li> <li><p>Look at the identity provider (IdP) logs.</p></li> <li><p>Make sure that the domains and ports for introspection and the external token endpoint are identical. Keycloak at least does not like it if they are not.</p></li> <li><p>Point the Ory Oathkeeper rule at https://httpbin.org/, usually the <code>/anything</code> path prefix which will reflect back everything it gets, making it easy to see what the service will see.</p></li></ul> <h3 id="components-required-in-addition-to-a-helm-chart"><a href="#components-required-in-addition-to-a-helm-chart" class="header-anchor">#</a> Components required in addition to a Helm chart</h3> <p>The following pieces will be needed in addition to the Helm chart:</p> <ul><li>a JWKS secret</li> <li>annotated Helm values</li></ul> <h4 id="jwks-secret"><a href="#jwks-secret" class="header-anchor">#</a> JWKS secret</h4> <p>A secret should be created with key <code>mutator.id_token.jwks.json</code> and the value of a JWKS suitable for use with Ory Oathkeeper. An initial one can be generated as described in <a href="https://www.ory.sh/oathkeeper/docs/configure-deploy#cryptographic-keys" target="_blank" rel="noopener noreferrer">Configure and Deploy | ORY Oathkeeper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It will contain both public and private keys.</p> <h5 id="operating-with-the-jwks-secret"><a href="#operating-with-the-jwks-secret" class="header-anchor">#</a> Operating with the JWKS secret</h5> <p>To rotate the secret, apply the following procedure:</p> <ol start="0"><li>Note the time.</li> <li>Add a public and private key pair to the beginning of the array in the JWKS (make sure all public JWKs have a specified unique <code>kid</code>) in the secret. All keys other than the new keys and the previous first public and private keys can be removed. This is because Ory Oathkeeper always signs with the first key.</li> <li>Wait until all requests that Ory Oathkeeper might have received and authorized would have had their JWT handled by the backend service. The main delay here is the time for the secret update to propagate, comprising the delay of the secret manager to the updated secret and the delay of the secret to the updated volume, which is probably at most a minute or two, so wait that long after the time in step 0.</li> <li>If the old secret is being removed (this is only necessary if a breach is suspected, otherwise step 1 is sufficient for periodic key rotation), remove it now.</li></ol> <h4 id="annotated-helm-values"><a href="#annotated-helm-values" class="header-anchor">#</a> Annotated Helm values</h4> <p>Several places will need to be changed to the rest-of-deployment-specific URLs or other values. Those places are described in the comments in the example below, as well as other commentary.</p> <p>How to setup the Proxy ingress is undecided at the time, as it will need to change when the solution is added to the IaC 3.xxx so that area of the config is still unspecified. This leaves the ingress out by default. Changing <code>ingress.proxy.enabled</code> to <code>true</code> will enable the proxy ingress. See the linked pages at the beginning for options  available for the built-in ingress configuration.</p> <p>If TLS needs to be terminated at Ory Oathkeeper, see the <code>tls</code> sections in the <a href="https://www.ory.sh/oathkeeper/docs/reference/configuration" target="_blank" rel="noopener noreferrer">config documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and combine that with secrets and the <code>deployment.extraVolumes</code> and <code>deployment.extraVolumeMounts</code> values.<br>
Prometheus is at <code>:9000/metrics</code> by default, if that is in use.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">oathkeeper</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">log</span><span class="token punctuation">:</span>
    <span class="token comment"># the maximum log level, we'll stick here or maybe debug if this is overwhelming until the config is verified</span>
    <span class="token comment"># then, we'll determine what log level to set based on needs</span>
    <span class="token key atrule">level</span><span class="token punctuation">:</span> trace
    <span class="token key atrule">access_rules</span><span class="token punctuation">:</span>
      <span class="token key atrule">matching_strategy</span><span class="token punctuation">:</span> regexp
    <span class="token key atrule">authenticators</span><span class="token punctuation">:</span>
      <span class="token key atrule">cookie_session</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token comment"># this should be the internal URL of the public Kratos service's whoami endpoint, which might look like the below</span>
          <span class="token key atrule">check_session_url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//kratos<span class="token punctuation">-</span>public/sessions/whoami
          <span class="token key atrule">preserve_path</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token comment"># this means we automatically sweep up all the metadata kratos provides for use</span>
          <span class="token comment"># in, for example, the JWT, if we ever have more</span>
          <span class="token key atrule">extra_from</span><span class="token punctuation">:</span> <span class="token string">&quot;@this&quot;</span>
          <span class="token comment"># kratos will be configured to put the subject from the IdP here</span>
          <span class="token key atrule">subject_from</span><span class="token punctuation">:</span> <span class="token string">&quot;identity.id&quot;</span>
          <span class="token key atrule">only</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ory_kratos_session
      <span class="token key atrule">oauth2_introspection</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token key atrule">introspection_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//whatever/the/wso2/url/is/oauth2/introspect
          <span class="token key atrule">introspection_request_headers</span><span class="token punctuation">:</span>
          <span class="token comment"># see https://is.docs.wso2.com/en/latest/learn/invoke-the-oauth-introspection-endpoint/ for what credentials</span>
          <span class="token comment"># will need to be configured here</span>
          <span class="token comment"># also, this does not seem to be settable via environment variable, which means it is </span>
          <span class="token key atrule">authorization</span><span class="token punctuation">:</span> <span class="token string">&quot;Basic SOME WORKING AUTH HERE&quot;</span>
          <span class="token key atrule">cache</span><span class="token punctuation">:</span>
            <span class="token comment"># disabled to make debugging easier. enable for caching.</span>
            <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token key atrule">ttl</span><span class="token punctuation">:</span> <span class="token string">&quot;60s&quot;</span>
    <span class="token key atrule">authorizers</span><span class="token punctuation">:</span>
      <span class="token key atrule">remote_json</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token comment"># the check URL for Keto. This will be POST'd to. See https://www.ory.sh/keto/docs/reference/rest-api#operation/postCheck</span>
          <span class="token key atrule">remote</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//internal<span class="token punctuation">-</span>keto<span class="token punctuation">-</span>url<span class="token punctuation">-</span>here/check
    <span class="token key atrule">mutators</span><span class="token punctuation">:</span>
      <span class="token key atrule">id_token</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token comment"># this should be the internal base URL for the API service, which will look something like the below</span>
          <span class="token key atrule">issuer_url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//whatever<span class="token punctuation">-</span>oathkeeper<span class="token punctuation">-</span>internal<span class="token punctuation">-</span>is<span class="token punctuation">-</span>api<span class="token punctuation">:</span>4456/
    <span class="token key atrule">errors</span><span class="token punctuation">:</span>
      <span class="token key atrule">fallback</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> json
      <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
        <span class="token key atrule">json</span><span class="token punctuation">:</span>
        <span class="token comment"># this gives API clients pretty error JSON</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token key atrule">verbose</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">redirect</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token comment"># set this to whatever the main URL is, it'll ensure that browser errors redirect there</span>
          <span class="token key atrule">to</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//whatever<span class="token punctuation">-</span>external<span class="token punctuation">-</span>main<span class="token punctuation">-</span>url<span class="token punctuation">-</span>is/
          <span class="token key atrule">when</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">error</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> unauthorized
            <span class="token punctuation">-</span> forbidden
            <span class="token key atrule">request</span><span class="token punctuation">:</span> 
            <span class="token key atrule">header</span><span class="token punctuation">:</span>
              <span class="token key atrule">accept</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> text/html
<span class="token key atrule">secret</span><span class="token punctuation">:</span>
  <span class="token comment"># without this we would need to put the JWKS in the config, which would mean we couldn't rotate it just by changing the secret</span>
  <span class="token key atrule">manage</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># change to whatever is used for secret name</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> oathkeeper<span class="token punctuation">-</span>jwks
<span class="token key atrule">deployment</span><span class="token punctuation">:</span>
  <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span>
    <span class="token comment"># for whatever reason this environment variable only gets set if the JWKS is in the config even though the rest of the secret mounting</span>
    <span class="token comment"># and such still happens</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MUTATORS_ID_TOKEN_CONFIG_JWKS_URL
    <span class="token key atrule">value</span><span class="token punctuation">:</span> file<span class="token punctuation">:</span>///etc/secrets/mutator.id_token.jwks.json


</code></pre></div><h3 id="rules"><a href="#rules" class="header-anchor">#</a> Rules</h3> <p>Rule resources will need to be created in Kubernetes for each backend “match” (URL regex plus HTTP method(s)) protected with a permission. The example provided below provides guidance.</p> <p>As the flexibility to define third-party services and bounded contexts increases, they can define their own rules (perhaps behind a Helm values flag), which express which permissions should be required for which URLs.</p> <p>The biggest potential issue here is that each match MUST be unique. If a request matches multiple, Ory Oathkeeper will complain. Once a general pattern is picked that results in unique regexes, this will not happen except with user error.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> oathkeeper.ory.sh/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Rule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> a<span class="token punctuation">-</span>unique<span class="token punctuation">-</span>name
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v0.36.0<span class="token punctuation">-</span>beta.4
  <span class="token key atrule">upstream</span><span class="token punctuation">:</span>
    <span class="token comment"># set to whatever URL this request should be forwarded to</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//internal<span class="token punctuation">-</span>url<span class="token punctuation">-</span>of<span class="token punctuation">-</span>backend<span class="token punctuation">-</span>service/
  <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token comment"># this might need to be http even if external is https, it depends on how ingress does things</span>
    <span class="token comment"># my recommendation is to have a given prefix, then the &quot;everything else in the domain name&quot; matcher</span>
    <span class="token comment"># so it doesn't need to be changed when the config is moved between various main domains</span>
    <span class="token comment"># then whatever is needed for the specific path (this is set to match all subpaths)</span>
    <span class="token comment"># regexes go in between angle brackets</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//example.&lt;<span class="token punctuation">[</span>^/<span class="token punctuation">]</span><span class="token important">*&gt;/&lt;.*&gt;</span>
    <span class="token key atrule">methods</span><span class="token punctuation">:</span>
    <span class="token comment"># whatever method(s) this rule applies to</span>
    <span class="token punctuation">-</span> GET
  <span class="token key atrule">authenticators</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">handler</span><span class="token punctuation">:</span> oauth2_introspection
    <span class="token comment"># comment out this second one to not allow browser-cookie access</span>
    <span class="token punctuation">-</span> <span class="token key atrule">handler</span><span class="token punctuation">:</span> cookie_session
  <span class="token key atrule">authorizer</span><span class="token punctuation">:</span>
    <span class="token key atrule">handler</span><span class="token punctuation">:</span> remote_json
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token comment"># these will generally be identical for all rules,</span>
      <span class="token comment"># except &quot;object&quot; will be changed to the permission ID that is relevant for</span>
      <span class="token comment"># this URL</span>
      <span class="token key atrule">payload</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      {
        &quot;namespace&quot;: &quot;permission&quot;,
        &quot;object&quot;: &quot;PERMISSION IDENTIFIER HERE&quot;,
        &quot;relation&quot;: &quot;granted&quot;,
        &quot;subject_id&quot;: &quot;{{ print .Subject }}&quot;
      }</span>
  <span class="token key atrule">mutators</span><span class="token punctuation">:</span>
    <span class="token comment"># change this to an empty array if the id_token isn't needed, if you want</span>
    <span class="token punctuation">-</span> <span class="token key atrule">handler</span><span class="token punctuation">:</span> id_token

</code></pre></div><h3 id="configure-ory-oathkeeper-to-use-kratos-as-its-cookie-authenticator"><a href="#configure-ory-oathkeeper-to-use-kratos-as-its-cookie-authenticator" class="header-anchor">#</a> Configure Ory Oathkeeper to use Kratos as its cookie Authenticator</h3> <p>This part of the config above is applicable. Reference documentation for Ory Oathkeeper authenticators is found <a href="https://www.ory.sh/oathkeeper/docs/next/pipeline/authn" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>    <span class="token key atrule">authenticators</span><span class="token punctuation">:</span>
      <span class="token key atrule">cookie_session</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token comment"># this should be the internal URL of the public Kratos service's whoami endpoint, which might look like the below</span>
          <span class="token key atrule">check_session_url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//kratos<span class="token punctuation">-</span>public/sessions/whoami
          <span class="token key atrule">preserve_path</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token comment"># this means we automatically sweep up all the metadata kratos provides for use</span>
          <span class="token comment"># in, for example, the JWT, if we ever have more</span>
          <span class="token key atrule">extra_from</span><span class="token punctuation">:</span> <span class="token string">&quot;@this&quot;</span>
          <span class="token comment"># kratos will be configured to put the subject from the IdP here</span>
          <span class="token key atrule">subject_from</span><span class="token punctuation">:</span> <span class="token string">&quot;identity.id&quot;</span>
          <span class="token key atrule">only</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ory_kratos_session

</code></pre></div><h3 id="configure-ory-oathkeeper-to-use-wso2-iskm-for-token-introspection"><a href="#configure-ory-oathkeeper-to-use-wso2-iskm-for-token-introspection" class="header-anchor">#</a> Configure Ory Oathkeeper to use WSO2 ISKM for token introspection</h3> <p>Reference documentation is found <a href="https://www.ory.sh/oathkeeper/docs/next/pipeline/authn" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>      <span class="token key atrule">oauth2_introspection</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token key atrule">introspection_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//whatever/the/wso2/url/is/oauth2/introspect
          <span class="token key atrule">introspection_request_headers</span><span class="token punctuation">:</span>
          <span class="token comment"># see https://is.docs.wso2.com/en/latest/learn/invoke-the-oauth-introspection-endpoint/ for what credentials</span>
          <span class="token comment"># will need to be configured here</span>
          <span class="token comment"># also, this does not seem to be settable via environment variable, which means it is </span>
          <span class="token key atrule">authorization</span><span class="token punctuation">:</span> <span class="token string">&quot;Basic SOME WORKING AUTH HERE&quot;</span>
          <span class="token key atrule">cache</span><span class="token punctuation">:</span>
            <span class="token comment"># disabled to make debugging easier. enable for caching.</span>
            <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token key atrule">ttl</span><span class="token punctuation">:</span> <span class="token string">&quot;60s&quot;</span>
</code></pre></div><h3 id="configure-ory-oathkeeper-to-use-ory-keto-as-its-authorizer"><a href="#configure-ory-oathkeeper-to-use-ory-keto-as-its-authorizer" class="header-anchor">#</a> Configure Ory Oathkeeper to use Ory Keto as its authorizer</h3> <p>This part of the config above is applicable.<br>
Reference documentation about Ory Oathkeeper authorizers is found <a href="https://www.ory.sh/oathkeeper/docs/next/pipeline/authz" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>    <span class="token key atrule">authorizers</span><span class="token punctuation">:</span>
      <span class="token key atrule">remote_json</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
          <span class="token comment"># the check URL for Keto. This will be POST'd to. See https://www.ory.sh/keto/docs/reference/rest-api#operation/postCheck</span>
          <span class="token key atrule">remote</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//internal<span class="token punctuation">-</span>keto<span class="token punctuation">-</span>url<span class="token punctuation">-</span>here/check

</code></pre></div><h2 id="ory-kratos-implementation-detail"><a href="#ory-kratos-implementation-detail" class="header-anchor">#</a> Ory Kratos – implementation detail</h2> <p>Ory Kratos is the part of the Ory Implementation suite that manages all the authentication flows.<br>
It is highly configurable and can connect to a variety and multiple of authentication systems and flows. The <a href="https://www.ory.sh/kratos/docs/next/" target="_blank" rel="noopener noreferrer">Kratos Documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> explain the extent of the configuration well. I.e. it is likely to cater for your requirements.<br>
In this workstream project, only the User Login and logout flow are required and implemented.<br>
It is useful to know that Kratos can also provided flows for:</p> <ul><li><strong>Self-service Login and Registration:</strong> Allow end-users to create and sign into accounts (we call them identities) using Username / Email and password combinations, Social Sign In (“Sign in with Google, GitHub”), Passwordless flows, and others.</li> <li><strong>Multi-Factor Authentication (MFA/2FA):</strong> Support protocols such as TOTP (RFC 6238 and IETF RFC 4226 - better known as Google Authenticator)</li> <li><strong>Account Verification:</strong> Verify that an E-Mail address, phone number, or physical address actually belong to that identity.</li> <li><strong>Account Recovery:</strong> Recover access using “Forgot Password” flows, Security Codes (in case of MFA device loss), etc.</li> <li><strong>Profile and Account Management:</strong> Update passwords, personal details, email addresses, linked social profiles using secure flows.</li> <li><strong>Admin APIs:</strong> Import, update, delete identities.<br>
… that may become important in future version of the IaC deployment designs.</li></ul> <h3 id="deployment-details"><a href="#deployment-details" class="header-anchor">#</a> Deployment details</h3> <p>The Kratos Helm Chart is described at <a href="https://k8s.ory.sh/helm/kratos.html" target="_blank" rel="noopener noreferrer">ORY Kratos Helm Chart | k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and defined at <a href="https://github.com/ory/k8s/tree/master/helm/charts/kratos" target="_blank" rel="noopener noreferrer">k8s/helm/charts/kratos at master · ory/k8s · GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Unlike Ory Oathkeeper, it does not have any related Maester handling a CRD. It does, however, need a database (which can be MySQL, PostgreSQL, CockroachDB, or a few others). The Helm repository is the same as for Ory Oathkeeper, and documented at <a href="https://k8s.ory.sh/helm/" target="_blank" rel="noopener noreferrer">ORY Helm Charts | k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. A configuration reference is at <a href="https://www.ory.sh/kratos/docs/reference/configuration" target="_blank" rel="noopener noreferrer">Configuration | Ory Kratos<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, but note that the Helm chart works slightly differently.</p> <p>In addition to a database, the other major difference for Kratos is that it requires a user interface, in the form of a small web application that handles rendering the current stage of what’s happening with Kratos to the browser and also doing the necessary backend communication to make that happen securely. In our case, the UI we’ll use is very simple, and is never actually visible—all it will do is immediately forward to the one OIDC Identity Provider (IdP) we’ll have configured and receive the related callback. This UI application has already been created and open sourced in the <code>modusbox</code> repository, and releases public docker images in the GitHub docker registry. The UI can be found at <a href="https://github.com/modusbox/kratos-ui-oidcer" target="_blank" rel="noopener noreferrer">GitHub - modusbox/kratos-ui-oidcer: A Kratos UI for forwarding immediately to a single configured OIDC provider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and is a very minimal Rust application with excellent test coverage and a tiny docker image (about 5 megabytes, https://github.com/modusbox/kratos-ui-oidcer/pkgs/container/oidcer ). It is referred to as ‘Shim’ in the above design documentation.</p> <p>For ease of hosting, Kratos and the UI should be mounted on separate paths on the same domain as the main user interface. Alternatively, it is possible to configure them on a different domain and configure Kratos to use cross-domain cookies. This document is written under the assumption the same-domain strategy is chosen.</p> <h3 id="connecting-to-the-main-ui"><a href="#connecting-to-the-main-ui" class="header-anchor">#</a> Connecting to the Main UI</h3> <p>A client must be created in the IdP that supports OIDC authorization code grants.  This client must be configured to redirect either to any URL under the main UI if it supports wildcards, or the specific URL for the path <code>/kratos/self-service/methods/oidc/callback/idp</code> (note that the last segment, <code>idp</code>, is the provider ID in the config, so both must change together). This client will be used in the helm chart values config.</p> <p>In order to connect successfully with Kratos, the Main UI must behave as follows:</p> <ol><li>Make a cookies-included request to <code>/kratos/sessions/whoami</code> (documented at <a href="https://www.ory.sh/kratos/docs/reference/api/#operation/toSession" target="_blank" rel="noopener noreferrer">HTTP API Documentation | Ory Kratos<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ), which returns a 200 and an object containing user metadata if the user is logged in, or a 401 if they are not.</li> <li>If the user is not logged in, either immediately redirect to or provide a link to <code>/kratos/self-service/registration/browser</code>. Note: <code>registration</code> in the URL is not a typo. This refers to registration with Kratos, which IdP users will not be initially. If the user already exists, Kratos will automatically follow the login flow instead.</li> <li>To log out, link the user to <code>/kratos/self-service/browser/flows/logout</code></li></ol> <h3 id="annotated-helm-values-2"><a href="#annotated-helm-values-2" class="header-anchor">#</a> Annotated Helm Values</h3> <p>This configuration assumes the helm deployment’s name is <code>kratos</code> and, that the Kratos service is exposed at <code>/kratos/</code> on the same domain as the main UI, and that the Kratos UI is exposed at <code>/auth/</code> on the same domain as the main UI.</p> <p>The Helm chart does support ingress creation, but is not covered in the documentation.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">deployment</span><span class="token punctuation">:</span>
  <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> extra<span class="token punctuation">-</span>config
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>extra<span class="token punctuation">-</span>config
  <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> extra<span class="token punctuation">-</span>config
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/config2
    <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">kratos</span><span class="token punctuation">:</span>
  <span class="token comment"># NOTE: helm chart deployment does not seem to automatically pick up</span>
  <span class="token comment"># on changes here</span>
  <span class="token key atrule">identitySchemas</span><span class="token punctuation">:</span>
    <span class="token comment"># TODO note the domain to be replaced in $id, the url doesn't need to resolve</span>
    <span class="token key atrule">&quot;identity.schema.json&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      {
        &quot;$id&quot;: &quot;http://REPLACE_THIS_WITH_SOME_MEANINGFUL_DOMAIN/schema/user&quot;,
        &quot;$schema&quot;: &quot;http://json-schema.org/draft-07/schema#&quot;,
        &quot;title&quot;: &quot;A user&quot;,
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
          &quot;traits&quot;: {
            &quot;type&quot;: &quot;object&quot;,
            &quot;properties&quot;: {
              &quot;email&quot;: {
                &quot;title&quot;: &quot;E-Mail&quot;,
                &quot;type&quot;: &quot;string&quot;,
                &quot;format&quot;: &quot;email&quot;
              },
              &quot;subject&quot;: {
                &quot;title&quot;: &quot;Subject&quot;,
                &quot;type&quot;: &quot;string&quot;
              },
              &quot;name&quot;: {
                &quot;title&quot;: &quot;Name&quot;,
                &quot;type&quot;: &quot;string&quot;
              }
            }
          }
        }
      }</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">identity</span><span class="token punctuation">:</span>
      <span class="token key atrule">default_schema_url</span><span class="token punctuation">:</span> file<span class="token punctuation">:</span>///etc/config/identity.schema.json
    <span class="token key atrule">courier</span><span class="token punctuation">:</span>
      <span class="token key atrule">smtp</span><span class="token punctuation">:</span>
        <span class="token key atrule">connection_uri</span><span class="token punctuation">:</span> smtp<span class="token punctuation">:</span>//unused/
    <span class="token comment"># TODO the appropriate database DSN needs to go here, or be wired up via a secret and the environment variable `DSN`</span>
    <span class="token key atrule">dsn</span><span class="token punctuation">:</span> TODO DATABASE DSN HERE
    <span class="token key atrule">hashers</span><span class="token punctuation">:</span>
      <span class="token key atrule">argon2</span><span class="token punctuation">:</span>
        <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">iterations</span><span class="token punctuation">:</span> <span class="token number">3</span>
        <span class="token comment"># add resources and increase this amount,</span>
        <span class="token comment"># if using passwords (vs oidc) in a production context</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token number">17000</span>
        <span class="token key atrule">salt_length</span><span class="token punctuation">:</span> <span class="token number">16</span>
        <span class="token key atrule">key_length</span><span class="token punctuation">:</span> <span class="token number">32</span>
    <span class="token key atrule">log</span><span class="token punctuation">:</span>
      <span class="token comment"># TODO adjust after successful setup, likely down to info</span>
      <span class="token key atrule">level</span><span class="token punctuation">:</span> trace
    <span class="token key atrule">selfservice</span><span class="token punctuation">:</span>
      <span class="token key atrule">flows</span><span class="token punctuation">:</span>
        <span class="token key atrule">registration</span><span class="token punctuation">:</span>
          <span class="token comment"># TODO if the place the UI goes changes, this needs to change</span>
          <span class="token key atrule">ui_url</span><span class="token punctuation">:</span> /auth/
          <span class="token key atrule">after</span><span class="token punctuation">:</span>
            <span class="token key atrule">oidc</span><span class="token punctuation">:</span>
              <span class="token key atrule">hooks</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">hook</span><span class="token punctuation">:</span> session
        <span class="token key atrule">logout</span><span class="token punctuation">:</span>
          <span class="token key atrule">after</span><span class="token punctuation">:</span>
            <span class="token comment"># TODO the IdP's logout URL should go here, with a redirect encoded into it if that's supported (might not work the same way, this is just an example)</span>
            <span class="token key atrule">default_browser_return_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//idp.logout.url.here/logout/path<span class="token punctuation">?</span>redirect_uri=https%3A%2F%2Fsomewhere.example.com%2F
      <span class="token key atrule">methods</span><span class="token punctuation">:</span>
        <span class="token key atrule">oidc</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">config</span><span class="token punctuation">:</span>
            <span class="token key atrule">providers</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> idp
              <span class="token key atrule">provider</span><span class="token punctuation">:</span> generic
              <span class="token comment"># TODO both the client_id and client_secret need to be set appropriately to the client supporting authorization code grants with openid</span>
              <span class="token comment"># TODO these can alternatively be set via environment variable from a k8s secret</span>
              <span class="token key atrule">client_id</span><span class="token punctuation">:</span> TODO
              <span class="token key atrule">client_secret</span><span class="token punctuation">:</span> TODO
              <span class="token key atrule">mapper_url</span><span class="token punctuation">:</span> file<span class="token punctuation">:</span>///etc/config2/oidc.jsonnet
              <span class="token comment"># TODO this should be the right IdP URL to perform OIDC discovery on</span>
              <span class="token comment"># If the IdP does not support discovery, auth_url and token_url can be set here instead</span>
              <span class="token comment"># some IdPs may also need a requested_claims, see Kratos config documentation if there seems to be an issue</span>
              <span class="token key atrule">issuer_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//some.public.idp.url.supporting.discovery/might/have/path/
              <span class="token key atrule">scope</span><span class="token punctuation">:</span>
              <span class="token comment"># TODO adjust requested scope based on IdP (WSO2) documentation</span>
              <span class="token punctuation">-</span> openid
        <span class="token key atrule">password</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token comment"># TODO set this to the base URL of the main UI</span>
      <span class="token key atrule">default_browser_return_url</span><span class="token punctuation">:</span> <span class="token string">&quot;https://somewhere.example.com/&quot;</span>
    <span class="token key atrule">serve</span><span class="token punctuation">:</span>
      <span class="token key atrule">public</span><span class="token punctuation">:</span>
        <span class="token comment"># TODO set this to the base URL of the main UI plus the `/kratos` path, will need to be updated if the same-domain approach is not used</span>
        <span class="token key atrule">base_url</span><span class="token punctuation">:</span> <span class="token string">&quot;https://somewhere.example.com/kratos&quot;</span>
  <span class="token key atrule">autoMigrate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><h3 id="jsonnet-configmap"><a href="#jsonnet-configmap" class="header-anchor">#</a> JSonnet ConfigMap</h3> <p>In the Kratos Helm values, it references a ConfigMap <code>kratos-extra-config</code> that contains JSonnet (a configuration language) referencing how to transform the IdP’s claims into what Kratos stores about the person. That ConfigMap should contain a key <code>oidc.jsonnet</code> with the following contents:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>local claims <span class="token operator">=</span> std<span class="token punctuation">.</span><span class="token function">extVar</span><span class="token punctuation">(</span><span class="token string">'claims'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">{</span>
  identity<span class="token operator">:</span> <span class="token punctuation">{</span>
    traits<span class="token operator">:</span> <span class="token punctuation">{</span>
      email<span class="token operator">:</span> claims<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
      name<span class="token operator">:</span> claims<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      subject<span class="token operator">:</span> claims<span class="token punctuation">.</span>sub
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The email and subject claims will probably never need to change, but with some IdPs, the name might be provided differently, in which case that part of the JSonnet will need to be updated. The keys inside <code>traits</code> are basically arbitrary (though <code>subject</code> has some dependencies elsewhere that would need to be updated), so long as they’re also updated in the schema in the config, but the values are restricted to the list of likely claims inside an OIDC ID Token, and are described in the Kratos documentation. This will probably not come up.</p> <h3 id="ui-deployment-service"><a href="#ui-deployment-service" class="header-anchor">#</a> UI Deployment &amp; Service</h3> <p>The service will also need to be exposed at an appropriate path, the config assumes <code>/auth/</code>, on the same domain as the main UI.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>ui
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>ui
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>ui

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>ui
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>ui
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>ui
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>ui
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kratos<span class="token punctuation">-</span>ui
        <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/modusbox/oidcer<span class="token punctuation">:</span>latest
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ROCKET_PORT
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;80&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ROCKET_REGISTRATION_ENDPOINT
          <span class="token comment"># TODO if the kratos helm chart is given a different name than kratos,</span>
          <span class="token comment"># the domain will be different here, it should be the domain of the kratos service</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//kratos<span class="token punctuation">-</span>public/self<span class="token punctuation">-</span>service/registration/flows
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><h3 id="ory-reference-links"><a href="#ory-reference-links" class="header-anchor">#</a> Ory reference links</h3> <ul><li><strong>Configuring Login Sessions.</strong> <a href="https://www.ory.sh/kratos/docs/guides/login-session" target="_blank" rel="noopener noreferrer">docs here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><strong>Configuring Session cookies.</strong> Details of the cookies sessions <a href="https://www.ory.sh/kratos/docs/guides/configuring-cookies" target="_blank" rel="noopener noreferrer">docs here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><strong>Configuring Kratos for CORS.</strong> <a href="https://www.ory.sh/kratos/docs/guides/setting-up-cors" target="_blank" rel="noopener noreferrer">docs here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><strong>Ory Kratos - Ory Oathkeeper integration (OIDC).</strong> <a href="https://www.ory.sh/kratos/docs/guides/zero-trust-iap-proxy-identity-access-proxy" target="_blank" rel="noopener noreferrer">Kratos docs here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><strong>Ory Kratos - WSO2 OIDC integration.</strong> <a href="https://www.ory.sh/kratos/docs/guides/sign-in-with-github-google-facebook-linkedin" target="_blank" rel="noopener noreferrer">docs here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/9/2023, 12:52:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/business-operations-framework-docs/guide/" class="prev router-link-active">
        Introduction
      </a></span> <span class="next"><a href="/business-operations-framework-docs/guide/Microfrontend-JAMStack.html">
        Micro-frontend - JAMStack design
      </a>
      →
    </span></p></div> </main> <!----></div></div> <!----></div><div class="global-ui"><!----></div></div>
    
    <script src="/business-operations-framework-docs/assets/js/app.e79f47cd.js" defer></script><script src="/business-operations-framework-docs/assets/js/2.65c7ddde.js" defer></script><script src="/business-operations-framework-docs/assets/js/3.94d7a4f5.js" defer></script>
  </body>
</html>
