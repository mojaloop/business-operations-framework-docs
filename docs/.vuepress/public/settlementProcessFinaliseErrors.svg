<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="5408px" preserveAspectRatio="none" style="width:3976px;height:5408px;background:#FFFFFF;" version="1.1" viewBox="0 0 3976 5408" width="3976px" zoomAndPan="magnify"><defs/><g><rect height="26.2969" style="stroke:#00000000;stroke-width:1.0;fill:none;" width="169" x="1899.5" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="159" x="1904.5" y="27.9951">Settlement Process</text><rect height="309.4375" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1167" x="2169.5" y="1095.3594"/><rect height="361.4375" style="stroke:#000000;stroke-width:1.5;fill:none;" width="716.5" x="2169.5" y="1418.7969"/><rect height="223.625" style="stroke:#000000;stroke-width:1.5;fill:none;" width="677.5" x="2169.5" y="1794.2344"/><rect height="553.875" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1940.5" x="1384.5" y="2031.8594"/><rect height="371.25" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1516.5" x="2159.5" y="3072.8594"/><rect height="140.6875" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1167" x="2169.5" y="3122.7344"/><rect height="399.1875" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1786.5" x="1560" y="3458.1094"/><rect height="112.75" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1167" x="2169.5" y="3507.9844"/><rect height="594.8125" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1796.5" x="1550" y="3871.2969"/><rect height="537.9375" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1776.5" x="1560" y="3921.1719"/><rect height="721.5" style="stroke:#000000;stroke-width:1.5;fill:none;" width="2574.5" x="1384.5" y="4480.1094"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="176" x2="176" y1="130.2344" y2="5316.4219"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="465" x2="465" y1="130.2344" y2="5316.4219"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="743.5" x2="743.5" y1="130.2344" y2="5316.4219"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1505.5" x2="1505.5" y1="130.2344" y2="5316.4219"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="2268.5" x2="2268.5" y1="130.2344" y2="5316.4219"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="2880.5" x2="2880.5" y1="130.2344" y2="5316.4219"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="3266.5" x2="3266.5" y1="130.2344" y2="5316.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="336" x="5" y="124.5742">Business Hub Operator User</text><ellipse cx="176" cy="50.7969" fill="#E3E3E3" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M176,58.7969 L176,85.7969 M163,66.7969 L189,66.7969 M176,85.7969 L163,100.7969 M176,85.7969 L189,100.7969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="336" x="5" y="5337.6992">Business Hub Operator User</text><ellipse cx="176" cy="5351.8594" fill="#E3E3E3" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M176,5359.8594 L176,5386.8594 M163,5367.8594 L189,5367.8594 M176,5386.8594 L163,5401.8594 M176,5386.8594 L189,5401.8594 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="217" x="357" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="203" x="364" y="116.5742">Settlement Bank</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="217" x="357" y="5315.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="203" x="364" y="5344.6992">Settlement Bank</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189" x="649.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="175" x="656.5" y="116.5742">Micro-frontend</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189" x="649.5" y="5315.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="175" x="656.5" y="5344.6992">Micro-frontend</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="223" x="1394.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="209" x="1401.5" y="116.5742">Experience Layer</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="223" x="1394.5" y="5315.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="209" x="1401.5" y="5344.6992">Experience Layer</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="179" x="2179.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="165" x="2186.5" y="116.5742">Process Layer</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="179" x="2179.5" y="5315.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="165" x="2186.5" y="5344.6992">Process Layer</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="2811.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="125" x="2818.5" y="116.5742">Report API</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="2811.5" y="5315.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="125" x="2818.5" y="5344.6992">Report API</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="119" x="3207.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="105" x="3214.5" y="116.5742">Mojaloop</text><rect fill="#E3E3E3" height="41.9375" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="119" x="3207.5" y="5315.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="105" x="3214.5" y="5344.6992">Mojaloop</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3969" x="0" y="167.2031"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3969" y1="167.2031" y2="167.2031"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3969" y1="170.2031" y2="170.2031"/><rect fill="#EEEEEE" height="35.9375" style="stroke:#000000;stroke-width:2.0;" width="292" x="1838.5" y="150.2344"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="270" x="1844.5" y="176.5117">Finalise Settlement</text><polygon fill="#181818" points="187,368.7969,177,372.7969,187,376.7969,183,372.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="181" x2="464.5" y1="372.7969" y2="372.7969"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="17" x="193" y="365.1367">1</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="214" y="365.1367"> </text><path d="M470,201.1719 L470,518.1719 L1156,518.1719 L1156,211.1719 L1146,201.1719 L470,201.1719 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M1146,201.1719 L1146,211.1719 L1156,211.1719 L1146,201.1719 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="45" x="476" y="228.4492">The</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="233" x="529" y="228.4492">Settlement Bank</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="274" x="770" y="228.4492">has completed making</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="378" x="476" y="256.3867">transfers between participants.</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="45" x="476" y="284.3242">The</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="247" x="529" y="284.3242">finalisation report</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="253" x="784" y="284.3242">that is recieved from</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="657" x="476" y="312.2617">the Settlement Bank, includes the settlement account</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="641" x="476" y="340.1992">balances after all the transfers have been processed.</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="476" y="368.1367"> </text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="590" x="476" y="396.0742">It is possible that these account balances are not</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="488" x="476" y="424.0117">as expected. This would indicate that an</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="136" x="972" y="424.0117">additional</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="1108" y="424.0117"> </text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="264" x="476" y="451.9492">funds in / funds out</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="363" x="748" y="451.9492">has occured in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="567" x="476" y="479.8867">accounts that has not yet been captured in the</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="354" x="476" y="507.8242">Mojaloop Settlement ledgers.</text><polygon fill="#181818" points="732,553.4219,742,557.4219,732,561.4219,736,557.4219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="176" x2="738" y1="557.4219" y2="557.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="16" x="183" y="549.7617">2</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="283" x="203" y="549.7617">Validate finalisation file</text><polygon fill="#181818" points="1494,595.3594,1504,599.3594,1494,603.3594,1498,599.3594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="744" x2="1500" y1="599.3594" y2="599.3594"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="17" x="751" y="591.6992">3</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="325" x="772" y="591.6992">POST: /settlements:finalize</text><line style="stroke:#181818;stroke-width:1.0;" x1="1506" x2="1548" y1="847.3281" y2="847.3281"/><line style="stroke:#181818;stroke-width:1.0;" x1="1548" x2="1548" y1="847.3281" y2="860.3281"/><line style="stroke:#181818;stroke-width:1.0;" x1="1507" x2="1548" y1="860.3281" y2="860.3281"/><polygon fill="#181818" points="1517,856.3281,1507,860.3281,1517,864.3281,1513,860.3281" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="17" x="1513" y="825.6992">4</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="307" x="1534" y="811.7305">Fatal: Validate file format</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="305" x="1542" y="839.668">Load file into JSON object</text><path d="M482,612.3594 L482,1041.3594 L1501,1041.3594 L1501,622.3594 L1491,612.3594 L482,612.3594 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M1491,612.3594 L1491,622.3594 L1501,622.3594 L1491,612.3594 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="488" y="639.6367">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="873" x="504" y="667.5742">"finalisationReference":"SettlementFinalisationFilename.xlsx" # (string),</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="635" x="504" y="695.5117">"settlementId" : 10 , # settlement batch id (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="197" x="504" y="723.4492">"participants" : [</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="520" y="751.3867">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="686" x="536" y="779.3242">"name": "payerfsp",# mojaloop participant name (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="488" x="536" y="807.2617">"id": 1, # mojaloop database id (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="905" x="536" y="835.1992">"settlementAccountId": 1, # settlement account id for participant (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="950" x="536" y="863.1367">"externalBalance": 10000, # external balance of settlement account (number)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="323" x="536" y="891.0742">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="284" x="584" y="919.0117">"amount": 0, # number</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="634" x="584" y="946.9492">"currency": "XXX" # currency string (CurrencyEnum)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="568" y="974.8867">}</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="686" x="520" y="1002.8242">}  ] # all participants that are involved in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="488" y="1030.7617">}</text><polygon fill="#181818" points="2257,1076.3594,2267,1080.3594,2257,1084.3594,2261,1080.3594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1506" x2="2263" y1="1080.3594" y2="1080.3594"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="16" x="1513" y="1072.6992">5</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="274" x="1533" y="1072.6992">Validate finalisation</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="325" x="1815" y="1072.6992">POST: /settlements:finalize</text><path d="M2169.5,1095.3594 L2504.5,1095.3594 L2504.5,1115.2969 L2494.5,1125.2969 L2169.5,1125.2969 L2169.5,1095.3594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="309.4375" style="stroke:#000000;stroke-width:1.5;" width="1167" x="2169.5" y="1095.3594"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="290" x="2184.5" y="1118.6367">load settlement data</text><polygon fill="#181818" points="3255,1183.1719,3265,1187.1719,3255,1191.1719,3259,1187.1719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="1187.1719" y2="1187.1719"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="16" x="2276" y="1165.543">6</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="331" x="2296" y="1151.5742">Get settlement information</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="583" x="2296" y="1179.5117">GET central-settlements/settlements/{id}</text><polygon fill="#181818" points="3255,1253.0469,3265,1257.0469,3255,1261.0469,3259,1257.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="1257.0469" y2="1257.0469"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="17" x="2276" y="1235.418">7</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="229" x="2297" y="1221.4492">Get all participants</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="2297" y="1249.3867"> </text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="430" x="2305" y="1249.3867">GET central-ledger/participants</text><polygon fill="#181818" points="3255,1322.9219,3265,1326.9219,3255,1330.9219,3259,1326.9219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="1326.9219" y2="1326.9219"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="16" x="2276" y="1305.293">8</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="304" x="2296" y="1291.3242">Get all participants limits</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="2296" y="1319.2617"> </text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="516" x="2304" y="1319.2617">GET central-ledger/participants/limits</text><polygon fill="#181818" points="3255,1392.7969,3265,1396.7969,3255,1400.7969,3259,1396.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="1396.7969" y2="1396.7969"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="17" x="2276" y="1375.168">9</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="491" x="2297" y="1361.1992">For each participant get account balance</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="2297" y="1389.1367"> </text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="679" x="2305" y="1389.1367">GET central-ledger/participants/{name}/accounts</text><path d="M2169.5,1418.7969 L2461.5,1418.7969 L2461.5,1438.7344 L2451.5,1448.7344 L2169.5,1448.7344 L2169.5,1418.7969 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="361.4375" style="stroke:#000000;stroke-width:1.5;" width="716.5" x="2169.5" y="1418.7969"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="247" x="2184.5" y="1442.0742">Process validation</text><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="2311" y1="1538.5469" y2="1538.5469"/><line style="stroke:#181818;stroke-width:1.0;" x1="2311" x2="2311" y1="1538.5469" y2="1551.5469"/><line style="stroke:#181818;stroke-width:1.0;" x1="2270" x2="2311" y1="1551.5469" y2="1551.5469"/><polygon fill="#181818" points="2280,1547.5469,2270,1551.5469,2280,1555.5469,2276,1551.5469" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="2276" y="1502.9492">10</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="438" x="2314" y="1475.0117">Fatal: Validate Participants and their</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="360" x="2322" y="1502.9492">accounts ids are valid, match,</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="560" x="2314" y="1530.8867">and are the correct type, and correct currency</text><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="2311" y1="1593.4844" y2="1593.4844"/><line style="stroke:#181818;stroke-width:1.0;" x1="2311" x2="2311" y1="1593.4844" y2="1606.4844"/><line style="stroke:#181818;stroke-width:1.0;" x1="2270" x2="2311" y1="1606.4844" y2="1606.4844"/><polygon fill="#181818" points="2280,1602.4844,2270,1606.4844,2280,1610.4844,2276,1606.4844" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="2276" y="1585.8242">11</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="519" x="2314" y="1585.8242">Fatal: Validate Settlement Id non-matching</text><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="2311" y1="1676.3594" y2="1676.3594"/><line style="stroke:#181818;stroke-width:1.0;" x1="2311" x2="2311" y1="1676.3594" y2="1689.3594"/><line style="stroke:#181818;stroke-width:1.0;" x1="2270" x2="2311" y1="1689.3594" y2="1689.3594"/><polygon fill="#181818" points="2280,1685.3594,2270,1689.3594,2280,1693.3594,2276,1689.3594" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="2276" y="1654.7305">12</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="514" x="2313" y="1640.7617">Fatal: Validate Participant Settlement data</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="240" x="2313" y="1668.6992">transfer sum is zero</text><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="2311" y1="1759.2344" y2="1759.2344"/><line style="stroke:#181818;stroke-width:1.0;" x1="2311" x2="2311" y1="1759.2344" y2="1772.2344"/><line style="stroke:#181818;stroke-width:1.0;" x1="2270" x2="2311" y1="1772.2344" y2="1772.2344"/><polygon fill="#181818" points="2280,1768.2344,2270,1772.2344,2280,1776.2344,2276,1772.2344" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="2276" y="1737.6055">13</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="514" x="2314" y="1723.6367">Fatal: Validate Participant Settlement data</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="392" x="2314" y="1751.5742">matches net settlement amount</text><path d="M2169.5,1794.2344 L2717.5,1794.2344 L2717.5,1814.1719 L2707.5,1824.1719 L2169.5,1824.1719 L2169.5,1794.2344 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="223.625" style="stroke:#000000;stroke-width:1.5;" width="677.5" x="2169.5" y="1794.2344"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="503" x="2184.5" y="1817.5117">Calculate Adjustments and Warnings</text><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="2311" y1="1913.9844" y2="1913.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="2311" x2="2311" y1="1913.9844" y2="1926.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="2270" x2="2311" y1="1926.9844" y2="1926.9844"/><polygon fill="#181818" points="2280,1922.9844,2270,1926.9844,2280,1930.9844,2276,1926.9844" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="2276" y="1878.3867">14</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="504" x="2314" y="1850.4492">Non fatal: Validate Participant Settlement</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="240" x="2314" y="1878.3867">balance is expected</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="513" x="2322" y="1906.3242">Return warnings if there are discrepencies</text><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="2311" y1="1996.8594" y2="1996.8594"/><line style="stroke:#181818;stroke-width:1.0;" x1="2311" x2="2311" y1="1996.8594" y2="2009.8594"/><line style="stroke:#181818;stroke-width:1.0;" x1="2270" x2="2311" y1="2009.8594" y2="2009.8594"/><polygon fill="#181818" points="2280,2005.8594,2270,2009.8594,2280,2013.8594,2276,2009.8594" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="2276" y="1975.2305">15</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="504" x="2313" y="1961.2617">Non fatal: Validate Participant Settlement</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="313" x="2313" y="1989.1992">balance is zero or positive</text><path d="M1384.5,2031.8594 L1466.5,2031.8594 L1466.5,2051.7969 L1456.5,2061.7969 L1384.5,2061.7969 L1384.5,2031.8594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="553.875" style="stroke:#000000;stroke-width:1.5;" width="1940.5" x="1384.5" y="2031.8594"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="37" x="1399.5" y="2055.1367">alt</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="129" x="1481.5" y="2056.1367">[Success]</text><polygon fill="#181818" points="1517,2149.5781,1507,2153.5781,1517,2157.5781,1513,2153.5781" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1511" x2="2268" y1="2153.5781" y2="2153.5781"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1523" y="2145.918">16</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="434" x="1560" y="2145.918">Return finalisation validation results</text><path d="M2274,2079.7344 L2274,2200.7344 L2925,2200.7344 L2925,2089.7344 L2915,2079.7344 L2274,2079.7344 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M2915,2079.7344 L2915,2089.7344 L2925,2089.7344 L2915,2079.7344 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="2107.0117">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="614" x="2296" y="2134.9492">"finalisationId": "GUIDv4", # Guid version 4 (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="586" x="2296" y="2162.8867">"valid":true # (boolean) true if none failure error</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="2190.8242">}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1384.5" x2="3325" y1="2207.4844" y2="2207.4844"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="149" x="1389.5" y="2229.7617">[Warnings]</text><polygon fill="#181818" points="1517,2325.2344,1507,2329.2344,1517,2333.2344,1513,2329.2344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1511" x2="2268" y1="2329.2344" y2="2329.2344"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="1523" y="2321.5742">17</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="521" x="1561" y="2321.5742">finalisation validation results with warnings</text><path d="M2274,2241.4219 L2274,2390.4219 L3310,2390.4219 L3310,2251.4219 L3300,2241.4219 L2274,2241.4219 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M3300,2241.4219 L3300,2251.4219 L3310,2251.4219 L3300,2241.4219 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="2268.6992">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="614" x="2296" y="2296.6367">"finalisationId": "GUIDv4", # Guid version 4 (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="601" x="2296" y="2324.5742">"valid":false, # (boolean) true if none failure error</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="999" x="2296" y="2352.5117">"warnings": [{"type": "string", "message": "description", "errorInformation": {...}}]</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="2380.4492">}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1384.5" x2="3325" y1="2397.1094" y2="2397.1094"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="90" x="1389.5" y="2419.3867">[Error]</text><polygon fill="#181818" points="1517,2514.8594,1507,2518.8594,1517,2522.8594,1513,2518.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1511" x2="2268" y1="2518.8594" y2="2518.8594"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1523" y="2511.1992">18</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="299" x="1560" y="2511.1992">Return Error, HTTP: code</text><path d="M2274,2431.0469 L2274,2580.0469 L3273,2580.0469 L3273,2441.0469 L3263,2431.0469 L2274,2431.0469 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M3263,2431.0469 L3263,2441.0469 L3273,2441.0469 L3263,2431.0469 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="2458.3242">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="614" x="2296" y="2486.2617">"finalisationId": "GUIDv4", # Guid version 4 (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="601" x="2296" y="2514.1992">"valid":false, # (boolean) true if none failure error</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="962" x="2296" y="2542.1367">"errors": [{"type": "string", "message": "description", "errorInformation": {...}}]</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="2570.0742">}</text><polygon fill="#181818" points="755,2622.6719,745,2626.6719,755,2630.6719,751,2626.6719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="749" x2="1505" y1="2626.6719" y2="2626.6719"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="761" y="2619.0117">19</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="370" x="799" y="2619.0117">Show validation results to user</text><polygon fill="#181818" points="187,2664.6094,177,2668.6094,187,2672.6094,183,2668.6094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="181" x2="743" y1="2668.6094" y2="2668.6094"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="193" y="2660.9492">20</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="230" y="2660.9492"> </text><polygon fill="#181818" points="732,2706.5469,742,2710.5469,732,2714.5469,736,2710.5469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="176" x2="738" y1="2710.5469" y2="2710.5469"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="183" y="2702.8867">21</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="507" x="220" y="2702.8867">User confirms proceeding with finalisation</text><polygon fill="#181818" points="1494,2807.3594,1504,2811.3594,1494,2815.3594,1498,2811.3594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="744" x2="1500" y1="2811.3594" y2="2811.3594"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="32" x="751" y="2803.6992">22</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="273" x="787" y="2803.6992">Confirm Finalisation</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="421" x="1068" y="2803.6992">POST: /settlements:confirmFinalize</text><path d="M59,2723.5469 L59,2872.5469 L739,2872.5469 L739,2733.5469 L729,2723.5469 L59,2723.5469 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M729,2723.5469 L729,2733.5469 L739,2733.5469 L729,2723.5469 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="65" y="2750.8242">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="375" x="81" y="2778.7617">finalisationId:"GUIDv4", (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="635" x="81" y="2806.6992">"settlementId" : 10 , # settlement batch id (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="522" x="81" y="2834.6367">balanceSettlementOption: true # (boolean)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="65" y="2862.5742">}</text><polygon fill="#181818" points="2257,2981.0156,2267,2985.0156,2257,2989.0156,2261,2985.0156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1506" x2="2263" y1="2985.0156" y2="2985.0156"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1513" y="2977.3555">23</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="273" x="1550" y="2977.3555">Confirm Finalisation</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="421" x="1831" y="2977.3555">POST: /settlements:confirmFinalize</text><path d="M821,2883.2344 L821,3060.2344 L1501,3060.2344 L1501,2893.2344 L1491,2883.2344 L821,2883.2344 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M1491,2883.2344 L1491,2893.2344 L1501,2893.2344 L1491,2883.2344 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="827" y="2910.5117">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="397" x="843" y="2938.4492">"finalisationId":"GUIDv4", (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="635" x="843" y="2966.3867">"settlementId" : 10 , # settlement batch id (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="544" x="843" y="2994.3242">"balanceSettlementOption":true, # (boolean)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="350" x="843" y="3022.2617">"user":"userName" # (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="827" y="3050.1992">}</text><path d="M2159.5,3072.8594 L2261.5,3072.8594 L2261.5,3092.7969 L2251.5,3102.7969 L2159.5,3102.7969 L2159.5,3072.8594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="371.25" style="stroke:#000000;stroke-width:1.5;" width="1516.5" x="2159.5" y="3072.8594"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="57" x="2174.5" y="3096.1367">loop</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="535" x="2276.5" y="3097.1367">[for each settlement debit participant]</text><path d="M2169.5,3122.7344 L2251.5,3122.7344 L2251.5,3142.6719 L2241.5,3152.6719 L2169.5,3152.6719 L2169.5,3122.7344 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="140.6875" style="stroke:#000000;stroke-width:1.5;" width="1167" x="2169.5" y="3122.7344"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="37" x="2184.5" y="3146.0117">alt</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="500" x="2266.5" y="3147.0117">[if balanceSettlementOption is true]</text><polygon fill="#181818" points="3255,3251.4219,3265,3255.4219,3255,3259.4219,3259,3255.4219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="3255.4219" y2="3255.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="2276" y="3219.8242">24</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="743" x="2313" y="3191.8867">Adjust settlment account according to settlement (funds Out)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="669" x="2321" y="3219.8242">POST central-ledger/participants/{name}/accounts/{id}</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="857" x="2313" y="3247.7617">Confirm PUT /participants/{name}/accounts/{id}/transfers/{transferId}</text><polygon fill="#181818" points="3255,3356.2344,3265,3360.2344,3255,3364.2344,3259,3360.2344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="3360.2344" y2="3360.2344"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2276" y="3324.6367">25</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="298" x="2312" y="3296.6992">Advance state to Settled</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="929" x="2312" y="3324.6367">PUT central-settlements/settlements/{sid}/participants/{pid}/accounts/{aid}</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="504" x="2320" y="3352.5742">PUT /settlements/{sid}/participants/{pid}</text><path d="M3272,3373.2344 L3272,3438.2344 L3666,3438.2344 L3666,3383.2344 L3656,3373.2344 L3272,3373.2344 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M3656,3373.2344 L3656,3383.2344 L3666,3383.2344 L3656,3373.2344 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="130" x="3278" y="3400.5117">Net debit</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="130" x="3416" y="3400.5117">participant</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="349" x="3302" y="3428.4492">position ledgers are adjusted</text><path d="M1560,3458.1094 L1662,3458.1094 L1662,3478.0469 L1652,3488.0469 L1560,3488.0469 L1560,3458.1094 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="399.1875" style="stroke:#000000;stroke-width:1.5;" width="1786.5" x="1560" y="3458.1094"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="57" x="1575" y="3481.3867">loop</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="544" x="1677" y="3482.3867">[for each settlement credit participant]</text><path d="M2169.5,3507.9844 L2251.5,3507.9844 L2251.5,3527.9219 L2241.5,3537.9219 L2169.5,3537.9219 L2169.5,3507.9844 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="112.75" style="stroke:#000000;stroke-width:1.5;" width="1167" x="2169.5" y="3507.9844"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="37" x="2184.5" y="3531.2617">alt</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="500" x="2266.5" y="3532.2617">[if balanceSettlementOption is true]</text><polygon fill="#181818" points="3255,3608.7344,3265,3612.7344,3255,3616.7344,3259,3612.7344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="3612.7344" y2="3612.7344"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2276" y="3591.1055">26</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="722" x="2312" y="3577.1367">Adjust settlment account according to settlement (funds In)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="500" x="2320" y="3605.0742">POST /participants/{name}/accounts/{id}</text><path d="M1570,3632.7344 L1570,3753.7344 L2264,3753.7344 L2264,3642.7344 L2254,3632.7344 L1570,3632.7344 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M2254,3632.7344 L2254,3642.7344 L2264,3642.7344 L2254,3632.7344 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="405" x="1576" y="3660.0117">reason: "Settlement Finanisation"</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="169" x="1576" y="3687.9492">extension list:</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="457" x="1592" y="3715.8867">[ { 'key'='user', 'value'='username'},</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="641" x="1608" y="3743.8242">{ 'key'='reference', 'value'='finalisatonReference'} ]</text><polygon fill="#181818" points="3255,3845.2969,3265,3849.2969,3255,3853.2969,3259,3849.2969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="3849.2969" y2="3849.2969"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="2276" y="3813.6992">27</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="298" x="2313" y="3785.7617">Advance state to Settled</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="929" x="2313" y="3813.6992">PUT central-settlements/settlements/{sid}/participants/{pid}/accounts/{aid}</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="504" x="2321" y="3841.6367">PUT /settlements/{sid}/participants/{pid}</text><path d="M1550,3871.2969 L1632,3871.2969 L1632,3891.2344 L1622,3901.2344 L1550,3901.2344 L1550,3871.2969 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="594.8125" style="stroke:#000000;stroke-width:1.5;" width="1796.5" x="1550" y="3871.2969"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="37" x="1565" y="3894.5742">alt</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="500" x="1647" y="3895.5742">[if balanceSettlementOption is true]</text><path d="M1560,3921.1719 L1662,3921.1719 L1662,3941.1094 L1652,3951.1094 L1560,3951.1094 L1560,3921.1719 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="537.9375" style="stroke:#000000;stroke-width:1.5;" width="1776.5" x="1560" y="3921.1719"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="57" x="1575" y="3944.4492">loop</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="720" x="1677" y="3945.4492">[For each participant rebalance Settlement account]</text><polygon fill="#181818" points="3255,4021.9219,3265,4025.9219,3255,4029.9219,3259,4025.9219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="4025.9219" y2="4025.9219"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2276" y="4004.293">28</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="220" x="2312" y="3990.3242">Get latest balance</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="2312" y="4018.2617"> </text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="679" x="2320" y="4018.2617">GET central-ledger/participants/{name}/accounts</text><polygon fill="#181818" points="3255,4119.7344,3265,4123.7344,3255,4127.7344,3259,4123.7344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="4123.7344" y2="4123.7344"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="2276" y="4088.1367">29</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="290" x="2313" y="4060.1992">if &lt; actual balance then</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="324" x="2321" y="4088.1367">increase balance (funds In)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="669" x="2321" y="4116.0742">POST central-ledger/participants/{name}/accounts/{id}</text><polygon fill="#181818" points="3255,4245.4844,3265,4249.4844,3255,4253.4844,3259,4249.4844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="4249.4844" y2="4249.4844"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="2276" y="4199.918">30</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="290" x="2314" y="4158.0117">if &gt; actual balance then</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="353" x="2322" y="4185.9492">decrease balance (funds Out)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="669" x="2322" y="4213.8867">POST central-ledger/participants/{name}/accounts/{id}</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="857" x="2314" y="4241.8242">Confirm PUT /participants/{name}/accounts/{id}/transfers/{transferId}</text><path d="M1570,4262.4844 L1570,4383.4844 L2264,4383.4844 L2264,4272.4844 L2254,4262.4844 L1570,4262.4844 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M2254,4262.4844 L2254,4272.4844 L2264,4272.4844 L2254,4262.4844 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="386" x="1576" y="4289.7617">reason: "Settlement Rebalance"</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="169" x="1576" y="4317.6992">extension list:</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="457" x="1592" y="4345.6367">[ { 'key'='user', 'value'='username'},</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="641" x="1608" y="4373.5742">{ 'key'='reference', 'value'='finalisatonReference'} ]</text><polygon fill="#181818" points="3255,4447.1094,3265,4451.1094,3255,4455.1094,3259,4451.1094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2269" x2="3261" y1="4451.1094" y2="4451.1094"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="2276" y="4429.4805">31</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="289" x="2314" y="4415.5117">Confirm correct balance</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="8" x="2314" y="4443.4492"> </text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="679" x="2322" y="4443.4492">GET central-ledger/participants/{name}/accounts</text><path d="M1384.5,4480.1094 L1466.5,4480.1094 L1466.5,4500.0469 L1456.5,4510.0469 L1384.5,4510.0469 L1384.5,4480.1094 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="721.5" style="stroke:#000000;stroke-width:1.5;" width="2574.5" x="1384.5" y="4480.1094"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="37" x="1399.5" y="4503.3867">alt</text><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="129" x="1481.5" y="4504.3867">[Success]</text><polygon fill="#181818" points="1517,4667.6719,1507,4671.6719,1517,4675.6719,1513,4671.6719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1511" x2="2268" y1="4671.6719" y2="4671.6719"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1523" y="4664.0117">32</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="355" x="1560" y="4664.0117">Response success, HTTP: 200</text><path d="M2274,4527.9844 L2274,4788.9844 L3224,4788.9844 L3224,4537.9844 L3214,4527.9844 L2274,4527.9844 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M3214,4527.9844 L3214,4537.9844 L3224,4537.9844 L3214,4527.9844 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="4555.2617">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="198" x="2296" y="4583.1992">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="197" x="2296" y="4611.1367">"participants" : [</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2296" y="4639.0742">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="686" x="2312" y="4667.0117">"name": "payerfsp",# mojaloop participant name (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="488" x="2312" y="4694.9492">"id": 1, # mojaloop database id (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="897" x="2312" y="4722.8867">"settlementAccountId": 1 # settlement account id for participant (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="24" x="2296" y="4750.8242">}]</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="4778.7617">}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1384.5" x2="3959" y1="4795.4219" y2="4795.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="244" x="1389.5" y="4817.6992">[Processing Error]</text><polygon fill="#181818" points="1517,4983.0156,1507,4987.0156,1517,4991.0156,1513,4987.0156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1511" x2="2268" y1="4987.0156" y2="4987.0156"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="1523" y="4979.3555">33</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="299" x="1561" y="4979.3555">Return Error, HTTP: code</text><path d="M2274,4829.3594 L2274,5118.3594 L3944,5118.3594 L3944,4839.3594 L3934,4829.3594 L2274,4829.3594 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M3934,4829.3594 L3934,4839.3594 L3944,4839.3594 L3934,4829.3594 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="4856.6367">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="198" x="2296" y="4884.5742">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="197" x="2296" y="4912.5117">"participants" : [</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2296" y="4940.4492">{</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="686" x="2312" y="4968.3867">"name": "payerfsp",# mojaloop participant name (string)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="488" x="2312" y="4996.3242">"id": 1, # mojaloop database id (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="905" x="2312" y="5024.2617">"settlementAccountId": 1, # settlement account id for participant (integer)</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="1617" x="2312" y="5052.1992">"errors": [{"type": "string", "message": "description", "errorInformation": {...}}] # errorInformation std fspiop error information object</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="24" x="2296" y="5080.1367">}]</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="15" x="2280" y="5108.0742">}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1384.5" x2="3959" y1="5124.7344" y2="5124.7344"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="236" x="1389.5" y="5147.0117">[Validation Error]</text><polygon fill="#181818" points="1517,5186.6094,1507,5190.6094,1517,5194.6094,1513,5190.6094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1511" x2="2268" y1="5190.6094" y2="5190.6094"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="34" x="1523" y="5182.9492">34</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="299" x="1561" y="5182.9492">Return Error, HTTP: code</text><path d="M2274,5158.6719 L2274,5195.6719 L3785,5195.6719 L3785,5168.6719 L3775,5158.6719 L2274,5158.6719 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M3775,5158.6719 L3775,5168.6719 L3785,5168.6719 L3775,5158.6719 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="1490" x="2280" y="5185.9492">{"type": "string", "message": "description", "errorInformation": {...}} # errorInformation std fspiop error information object</text><polygon fill="#181818" points="755,5294.4219,745,5298.4219,755,5302.4219,751,5298.4219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="749" x2="1505" y1="5298.4219" y2="5298.4219"/><text fill="#000000" font-family="sans-serif" font-size="24" font-weight="bold" lengthAdjust="spacing" textLength="33" x="761" y="5262.8242">35</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="136" x="798" y="5234.8867">Settlement</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="90" x="806" y="5262.8242">Process</text><text fill="#000000" font-family="sans-serif" font-size="24" lengthAdjust="spacing" textLength="671" x="806" y="5290.7617">Completed (Update settlement Status or display errors)</text><!--MD5=[b7689af6e60d728727971c5cd815d66c]
@startuml
skinparam activityFontSize 4
skinparam activityDiamondFontSize 30
skinparam activityArrowFontSize 24
skinparam defaultFontSize 24
skinparam noteFontSize 24
skinparam monochrome true
autonumber

title Settlement Process

actor "Business Hub Operator User" as bu

participant "Settlement Bank" as sbank
participant "Micro-frontend" as ui
participant "Experience Layer" as el
participant "Process Layer" as pl
participant "Report API" as report
participant "Mojaloop" as moja


== Finalise Settlement ==
sbank- ->bu: 
note right
The **Settlement Bank** has completed making
transfers between participants.
The **finalisation report** that is recieved from 
the Settlement Bank, includes the settlement account 
balances after all the transfers have been processed.

It is possible that these account balances are not
as expected. This would indicate that an **additional** 
**funds in / funds out** has occured in the settlement 
accounts that has not yet been captured in the 
Mojaloop Settlement ledgers.
end note
bu -> ui: Validate finalisation file
ui -> el: POST: /settlements:finalize
el -> el: Fatal: Validate file format \n Load file into JSON object
note left 
{
  "finalisationReference":"SettlementFinalisationFilename.xlsx" # (string),
  "settlementId" : 10 , # settlement batch id (integer) 
  "participants" : [
    { 
      "name": "payerfsp",# mojaloop participant name (string) 
      "id": 1, # mojaloop database id (integer)
      "settlementAccountId": 1, # settlement account id for participant (integer)
      "externalBalance": 10000, # external balance of settlement account (number)
      "netSettlementAmount": {
            "amount": 0, # number
            "currency": "XXX" # currency string (CurrencyEnum)
          }
    }  ] # all participants that are involved in the settlement
}
end note

el -> pl: **Validate finalisation** POST: /settlements:finalize
group load settlement data
pl->moja: Get settlement information \n**GET central-settlements/settlements/{id}**
pl->moja: Get all participants\n **GET central-ledger/participants**
pl->moja: Get all participants limits\n **GET central-ledger/participants/limits**
pl->moja: For each participant get account balance\n **GET central-ledger/participants/{name}/accounts**
end
group Process validation 
pl -> pl: Fatal: Validate Participants and their \n accounts ids are valid, match, \nand are the correct type, and correct currency
pl -> pl: Fatal: Validate Settlement Id non-matching
pl -> pl: Fatal: Validate Participant Settlement data \ntransfer sum is zero
pl -> pl: Fatal: Validate Participant Settlement data \nmatches net settlement amount
end
group Calculate Adjustments and Warnings
pl -> pl: Non fatal: Validate Participant Settlement \nbalance is expected \n Return warnings if there are discrepencies
pl -> pl: Non fatal: Validate Participant Settlement \nbalance is zero or positive
end
alt Success 
  pl- -> el: Return finalisation validation results
  note right
    {
      "finalisationId": "GUIDv4", # Guid version 4 (string)
      "valid":true # (boolean) true if none failure error
    }
  end note
else Warnings
  pl- -> el: finalisation validation results with warnings
  note right
  {
    "finalisationId": "GUIDv4", # Guid version 4 (string)
    "valid":false, # (boolean) true if none failure error
    "warnings": [{"type": "string", "message": "description", "errorInformation": {...}}]
  }
  end note
else Error 
  pl- -> el: Return Error, HTTP: code
  note right
  {
    "finalisationId": "GUIDv4", # Guid version 4 (string)
    "valid":false, # (boolean) true if none failure error
    "errors": [{"type": "string", "message": "description", "errorInformation": {...}}]
  }
  end note
end
el- -> ui: Show validation results to user
ui- -> bu: 

bu -> ui: User confirms proceeding with finalisation
ui -> el: **Confirm Finalisation** POST: /settlements:confirmFinalize
note left
{
  finalisationId:"GUIDv4", (string)
  "settlementId" : 10 , # settlement batch id (integer) 
  balanceSettlementOption: true # (boolean)
}
end note
el -> pl: **Confirm Finalisation** POST: /settlements:confirmFinalize
note left
{
  "finalisationId":"GUIDv4", (string)
  "settlementId" : 10 , # settlement batch id (integer) 
  "balanceSettlementOption":true, # (boolean)
  "user":"userName" # (string)
}
end note

loop for each settlement debit participant
' pl->moja: [Remove if Liquidity adjustment includes settlement account check]\nadjust ndc: PUT /participants/{name}/limits
alt if balanceSettlementOption is true 
pl->moja: Adjust settlment account according to settlement (funds Out)\n POST central-ledger/participants/{name}/accounts/{id}\nConfirm PUT /participants/{name}/accounts/{id}/transfers/{transferId}
end

pl->moja: Advance state to Settled\nPUT central-settlements/settlements/{sid}/participants/{pid}/accounts/{aid} \n PUT /settlements/{sid}/participants/{pid}
note right moja
**Net debit** participant 
   position ledgers are adjusted
end note

end loop
loop for each settlement credit participant
' pl->moja: [Remove if Liquidity adjustment includes settlement account check]\n adjust ndc: PUT /participants/{name}/limits
alt if balanceSettlementOption is true 
pl->moja: Adjust settlment account according to settlement (funds In)\n POST /participants/{name}/accounts/{id}
end
note left pl
  reason: "Settlement Finanisation"
  extension list: 
    [ { 'key'='user', 'value'='username'},
      { 'key'='reference', 'value'='finalisatonReference'} ]
end note
pl->moja: Advance state to Settled\nPUT central-settlements/settlements/{sid}/participants/{pid}/accounts/{aid} \n PUT /settlements/{sid}/participants/{pid}
end loop
alt if balanceSettlementOption is true 
loop For each participant rebalance Settlement account  
pl->moja: Get latest balance \n **GET central-ledger/participants/{name}/accounts**
pl->moja: if < actual balance then\n increase balance (funds In)\n POST central-ledger/participants/{name}/accounts/{id}
pl->moja: if > actual balance then\n decrease balance (funds Out)\n POST central-ledger/participants/{name}/accounts/{id}\nConfirm PUT /participants/{name}/accounts/{id}/transfers/{transferId}
note left pl
  reason: "Settlement Rebalance"
  extension list: 
    [ { 'key'='user', 'value'='username'},
      { 'key'='reference', 'value'='finalisatonReference'} ]
end note
pl->moja: Confirm correct balance\n **GET central-ledger/participants/{name}/accounts**
end 
end

alt Success
  pl- ->el: Response success, HTTP: 200
  note right 
    {
      "state": "string",
      "participants" : [
      { 
        "name": "payerfsp",# mojaloop participant name (string) 
        "id": 1, # mojaloop database id (integer)
        "settlementAccountId": 1 # settlement account id for participant (integer)
      }]
    }
  end note
else Processing Error 
  pl- ->el: Return Error, HTTP: code
  note right 
  {
    "state": "string",
    "participants" : [
    { 
      "name": "payerfsp",# mojaloop participant name (string) 
      "id": 1, # mojaloop database id (integer)
      "settlementAccountId": 1, # settlement account id for participant (integer)
      "errors": [{"type": "string", "message": "description", "errorInformation": {...}}] # errorInformation std fspiop error information object
    }]
  }
  end note
else Validation Error 
  pl- ->el: Return Error, HTTP: code
  note right 
    {"type": "string", "message": "description", "errorInformation": {...}} # errorInformation std fspiop error information object
  end note
end
el- ->ui: Settlement \n Process \n Completed (Update settlement Status or display errors)
@enduml

@startuml
skinparam activityFontSize 4
skinparam activityDiamondFontSize 30
skinparam activityArrowFontSize 24
skinparam defaultFontSize 24
skinparam noteFontSize 24
skinparam monochrome true
autonumber

title Settlement Process

actor "Business Hub Operator User" as bu

participant "Settlement Bank" as sbank
participant "Micro-frontend" as ui
participant "Experience Layer" as el
participant "Process Layer" as pl
participant "Report API" as report
participant "Mojaloop" as moja


== Finalise Settlement ==
sbank- ->bu: 
note right
The **Settlement Bank** has completed making
transfers between participants.
The **finalisation report** that is recieved from 
the Settlement Bank, includes the settlement account 
balances after all the transfers have been processed.

It is possible that these account balances are not
as expected. This would indicate that an **additional** 
**funds in / funds out** has occured in the settlement 
accounts that has not yet been captured in the 
Mojaloop Settlement ledgers.
end note
bu -> ui: Validate finalisation file
ui -> el: POST: /settlements:finalize
el -> el: Fatal: Validate file format \n Load file into JSON object
note left 
{
  "finalisationReference":"SettlementFinalisationFilename.xlsx" # (string),
  "settlementId" : 10 , # settlement batch id (integer) 
  "participants" : [
    { 
      "name": "payerfsp",# mojaloop participant name (string) 
      "id": 1, # mojaloop database id (integer)
      "settlementAccountId": 1, # settlement account id for participant (integer)
      "externalBalance": 10000, # external balance of settlement account (number)
      "netSettlementAmount": {
            "amount": 0, # number
            "currency": "XXX" # currency string (CurrencyEnum)
          }
    }  ] # all participants that are involved in the settlement
}
end note

el -> pl: **Validate finalisation** POST: /settlements:finalize
group load settlement data
pl->moja: Get settlement information \n**GET central-settlements/settlements/{id}**
pl->moja: Get all participants\n **GET central-ledger/participants**
pl->moja: Get all participants limits\n **GET central-ledger/participants/limits**
pl->moja: For each participant get account balance\n **GET central-ledger/participants/{name}/accounts**
end
group Process validation 
pl -> pl: Fatal: Validate Participants and their \n accounts ids are valid, match, \nand are the correct type, and correct currency
pl -> pl: Fatal: Validate Settlement Id non-matching
pl -> pl: Fatal: Validate Participant Settlement data \ntransfer sum is zero
pl -> pl: Fatal: Validate Participant Settlement data \nmatches net settlement amount
end
group Calculate Adjustments and Warnings
pl -> pl: Non fatal: Validate Participant Settlement \nbalance is expected \n Return warnings if there are discrepencies
pl -> pl: Non fatal: Validate Participant Settlement \nbalance is zero or positive
end
alt Success 
  pl- -> el: Return finalisation validation results
  note right
    {
      "finalisationId": "GUIDv4", # Guid version 4 (string)
      "valid":true # (boolean) true if none failure error
    }
  end note
else Warnings
  pl- -> el: finalisation validation results with warnings
  note right
  {
    "finalisationId": "GUIDv4", # Guid version 4 (string)
    "valid":false, # (boolean) true if none failure error
    "warnings": [{"type": "string", "message": "description", "errorInformation": {...}}]
  }
  end note
else Error 
  pl- -> el: Return Error, HTTP: code
  note right
  {
    "finalisationId": "GUIDv4", # Guid version 4 (string)
    "valid":false, # (boolean) true if none failure error
    "errors": [{"type": "string", "message": "description", "errorInformation": {...}}]
  }
  end note
end
el- -> ui: Show validation results to user
ui- -> bu: 

bu -> ui: User confirms proceeding with finalisation
ui -> el: **Confirm Finalisation** POST: /settlements:confirmFinalize
note left
{
  finalisationId:"GUIDv4", (string)
  "settlementId" : 10 , # settlement batch id (integer) 
  balanceSettlementOption: true # (boolean)
}
end note
el -> pl: **Confirm Finalisation** POST: /settlements:confirmFinalize
note left
{
  "finalisationId":"GUIDv4", (string)
  "settlementId" : 10 , # settlement batch id (integer) 
  "balanceSettlementOption":true, # (boolean)
  "user":"userName" # (string)
}
end note

loop for each settlement debit participant
alt if balanceSettlementOption is true 
pl->moja: Adjust settlment account according to settlement (funds Out)\n POST central-ledger/participants/{name}/accounts/{id}\nConfirm PUT /participants/{name}/accounts/{id}/transfers/{transferId}
end

pl->moja: Advance state to Settled\nPUT central-settlements/settlements/{sid}/participants/{pid}/accounts/{aid} \n PUT /settlements/{sid}/participants/{pid}
note right moja
**Net debit** participant 
   position ledgers are adjusted
end note

end loop
loop for each settlement credit participant
alt if balanceSettlementOption is true 
pl->moja: Adjust settlment account according to settlement (funds In)\n POST /participants/{name}/accounts/{id}
end
note left pl
  reason: "Settlement Finanisation"
  extension list: 
    [ { 'key'='user', 'value'='username'},
      { 'key'='reference', 'value'='finalisatonReference'} ]
end note
pl->moja: Advance state to Settled\nPUT central-settlements/settlements/{sid}/participants/{pid}/accounts/{aid} \n PUT /settlements/{sid}/participants/{pid}
end loop
alt if balanceSettlementOption is true 
loop For each participant rebalance Settlement account  
pl->moja: Get latest balance \n **GET central-ledger/participants/{name}/accounts**
pl->moja: if < actual balance then\n increase balance (funds In)\n POST central-ledger/participants/{name}/accounts/{id}
pl->moja: if > actual balance then\n decrease balance (funds Out)\n POST central-ledger/participants/{name}/accounts/{id}\nConfirm PUT /participants/{name}/accounts/{id}/transfers/{transferId}
note left pl
  reason: "Settlement Rebalance"
  extension list: 
    [ { 'key'='user', 'value'='username'},
      { 'key'='reference', 'value'='finalisatonReference'} ]
end note
pl->moja: Confirm correct balance\n **GET central-ledger/participants/{name}/accounts**
end 
end

alt Success
  pl- ->el: Response success, HTTP: 200
  note right 
    {
      "state": "string",
      "participants" : [
      { 
        "name": "payerfsp",# mojaloop participant name (string) 
        "id": 1, # mojaloop database id (integer)
        "settlementAccountId": 1 # settlement account id for participant (integer)
      }]
    }
  end note
else Processing Error 
  pl- ->el: Return Error, HTTP: code
  note right 
  {
    "state": "string",
    "participants" : [
    { 
      "name": "payerfsp",# mojaloop participant name (string) 
      "id": 1, # mojaloop database id (integer)
      "settlementAccountId": 1, # settlement account id for participant (integer)
      "errors": [{"type": "string", "message": "description", "errorInformation": {...}}] # errorInformation std fspiop error information object
    }]
  }
  end note
else Validation Error 
  pl- ->el: Return Error, HTTP: code
  note right 
    {"type": "string", "message": "description", "errorInformation": {...}} # errorInformation std fspiop error information object
  end note
end
el- ->ui: Settlement \n Process \n Completed (Update settlement Status or display errors)
@enduml

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>